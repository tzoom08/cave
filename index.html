<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a0a00">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Cave ‚Äî Wine Cellar</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Inconsolata:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0603;
    --bg2: #160c07;
    --bg3: #1f1109;
    --surface: #2a1a0e;
    --surface2: #3a2416;
    --border: #4a3020;
    --border-light: #6a4830;
    --wine: #8b1a1a;
    --wine-light: #c42b2b;
    --gold: #c4952a;
    --gold-light: #e8b84b;
    --cream: #e8dcc8;
    --cream-dim: #a89070;
    --text: #e8dcc8;
    --text-dim: #8a7060;
    --text-muted: #5a4030;
    --green: #4a8a4a;
    --radius: 2px;
    --font-serif: 'Cormorant Garamond', Georgia, serif;
    --font-mono: 'Inconsolata', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* LAYOUT */
  #app { display: flex; flex-direction: column; min-height: 100vh; }

  header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--font-serif);
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 0.15em;
    color: var(--gold);
    font-style: italic;
  }

  .logo span {
    font-size: 11px;
    font-family: var(--font-mono);
    font-style: normal;
    color: var(--text-dim);
    letter-spacing: 0.2em;
    display: block;
    margin-top: -4px;
  }

  .header-actions { display: flex; gap: 8px; align-items: center; }

  .sync-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--text-muted);
  }

  .sync-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
  }
  .sync-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .sync-dot.syncing { background: var(--gold); animation: pulse 1s infinite; }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  nav {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex;
    padding: 0 20px;
    gap: 0;
  }

  .nav-tab {
    padding: 10px 20px;
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    white-space: nowrap;
  }
  .nav-tab:hover { color: var(--cream-dim); }
  .nav-tab.active { color: var(--gold); border-bottom-color: var(--gold); }

  main { flex: 1; padding: 24px 20px; max-width: 1200px; margin: 0 auto; width: 100%; }

  /* VIEWS */
  .view { display: none; }
  .view.active { display: block; }

  /* CARDS & SURFACES */
  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .card-sm { padding: 14px 16px; }

  /* BUTTONS */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--cream-dim);
    cursor: pointer;
    border-radius: var(--radius);
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn:hover { background: var(--surface2); border-color: var(--border-light); color: var(--cream); }
  .btn-primary { background: var(--wine); border-color: var(--wine-light); color: var(--cream); }
  .btn-primary:hover { background: var(--wine-light); }
  .btn-gold { background: transparent; border-color: var(--gold); color: var(--gold); }
  .btn-gold:hover { background: var(--gold); color: var(--bg); }
  .btn-sm { padding: 5px 10px; font-size: 9px; }
  .btn-icon { padding: 8px; }

  /* INPUTS */
  input, select, textarea {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--cream);
    font-family: var(--font-mono);
    font-size: 12px;
    padding: 8px 12px;
    border-radius: var(--radius);
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--gold); }
  input::placeholder { color: var(--text-muted); }
  select option { background: var(--bg3); }

  label {
    font-size: 9px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    display: block;
    margin-bottom: 5px;
  }

  .field { margin-bottom: 14px; }

  /* GRID */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

  /* SECTION HEADER */
  .section-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  .section-title {
    font-family: var(--font-serif);
    font-size: 26px;
    font-weight: 300;
    color: var(--cream);
    font-style: italic;
  }
  .section-count {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.1em;
  }

  /* ===========================
     COLLECTION VIEW
  =========================== */
  #search-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
  }

  #search-input { flex: 1; }

  .filter-row {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filter-chip {
    padding: 4px 12px;
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    background: none;
    white-space: nowrap;
  }
  .filter-chip:hover, .filter-chip.active { border-color: var(--wine); color: var(--wine-light); background: rgba(139,26,26,0.1); }

  .bottle-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
  }

  .bottle-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .bottle-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--wine);
  }
  .bottle-card:hover { border-color: var(--border-light); background: var(--bg3); transform: translateY(-1px); }
  .bottle-card.red::before { background: var(--wine); }
  .bottle-card.white::before { background: var(--gold); }
  .bottle-card.rose::before { background: #c47080; }
  .bottle-card.sparkling::before { background: #8080c4; }
  .bottle-card.orange::before { background: #c47030; }

  .bottle-name {
    font-family: var(--font-serif);
    font-size: 16px;
    font-weight: 400;
    color: var(--cream);
    margin-bottom: 2px;
    line-height: 1.3;
  }
  .bottle-producer {
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 0.08em;
    margin-bottom: 10px;
  }
  .bottle-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  .tag {
    font-size: 9px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 2px 7px;
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text-muted);
  }
  .tag.vintage { border-color: var(--gold); color: var(--gold); }
  .tag.varietal { border-color: var(--border-light); color: var(--cream-dim); }

  .bottle-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
  }
  .bottle-location {
    font-size: 9px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
  }
  .bottle-rating {
    font-family: var(--font-serif);
    font-size: 14px;
    color: var(--gold);
  }
  .bottle-price {
    font-size: 10px;
    color: var(--green);
    letter-spacing: 0.05em;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-state .es-icon {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
    opacity: 0.3;
  }
  .empty-state h3 {
    font-family: var(--font-serif);
    font-size: 22px;
    font-weight: 300;
    font-style: italic;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .empty-state p { font-size: 11px; line-height: 1.7; }

  /* ===========================
     ADD BOTTLE VIEW
  =========================== */
  #scan-area {
    border: 1px dashed var(--border-light);
    border-radius: var(--radius);
    padding: 30px;
    text-align: center;
    margin-bottom: 20px;
    background: var(--bg3);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }
  #scan-area:hover { border-color: var(--gold); }
  #scan-area.active { border-color: var(--wine-light); border-style: solid; }

  #scanner-video {
    width: 100%;
    max-width: 400px;
    height: 200px;
    object-fit: cover;
    display: none;
    border-radius: var(--radius);
    margin: 10px auto;
  }

  .scan-icon { font-size: 36px; color: var(--text-muted); margin-bottom: 10px; }
  .scan-hint { font-size: 10px; color: var(--text-muted); letter-spacing: 0.1em; }

  .or-divider {
    display: flex;
    align-items: center;
    gap: 16px;
    margin: 20px 0;
    color: var(--text-muted);
    font-size: 10px;
    letter-spacing: 0.15em;
  }
  .or-divider::before, .or-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .form-section {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }
  .form-section-title {
    font-size: 9px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .search-results {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg3);
    max-height: 200px;
    overflow-y: auto;
    display: none;
  }
  .search-result-item {
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:hover { background: var(--surface); }
  .sri-name { font-size: 13px; color: var(--cream); margin-bottom: 2px; }
  .sri-meta { font-size: 10px; color: var(--text-dim); }

  /* ===========================
     CELLAR MAP VIEW
  =========================== */
  .rack-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .rack-selector {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .rack-tab {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    cursor: pointer;
    background: none;
    transition: all 0.15s;
  }
  .rack-tab:hover { border-color: var(--border-light); color: var(--cream-dim); }
  .rack-tab.active { border-color: var(--wine); color: var(--wine-light); background: rgba(139,26,26,0.1); }

  #rack-grid {
    display: inline-grid;
    gap: 4px;
    background: var(--bg3);
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: auto;
    max-width: 100%;
  }

  .rack-slot {
    width: 44px;
    height: 44px;
    border: 1px solid var(--border);
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg2);
  }
  .rack-slot:hover { border-color: var(--border-light); }
  .rack-slot.occupied { background: var(--surface); }
  .rack-slot.occupied.red { background: rgba(139,26,26,0.25); border-color: var(--wine); }
  .rack-slot.occupied.white { background: rgba(196,149,42,0.2); border-color: var(--gold); }
  .rack-slot.occupied.rose { background: rgba(196,112,128,0.2); border-color: #c47080; }
  .rack-slot.occupied.sparkling { background: rgba(128,128,196,0.2); border-color: #8080c4; }
  .rack-slot.occupied.orange { background: rgba(196,112,48,0.2); border-color: #c47030; }
  .rack-slot.selected { box-shadow: 0 0 0 2px var(--gold); }
  .rack-slot-label {
    font-size: 7px;
    color: var(--text-muted);
    position: absolute;
    bottom: 2px;
    right: 3px;
    letter-spacing: 0;
  }
  .rack-slot-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--wine);
    display: none;
  }
  .rack-slot.occupied .rack-slot-dot { display: block; }

  .rack-legend {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    flex-wrap: wrap;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 9px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
  }
  .legend-dot {
    width: 10px; height: 10px;
    border-radius: 2px;
  }

  .slot-tooltip {
    position: fixed;
    background: var(--bg2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 12px 14px;
    pointer-events: none;
    z-index: 200;
    max-width: 200px;
    display: none;
  }
  .slot-tooltip.visible { display: block; }
  .st-name { font-family: var(--font-serif); font-size: 15px; color: var(--cream); margin-bottom: 3px; }
  .st-meta { font-size: 10px; color: var(--text-dim); }

  /* ===========================
     BOTTLE DETAIL MODAL
  =========================== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 300;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  .modal-header {
    padding: 24px 24px 0;
    border-bottom: 1px solid var(--border);
    padding-bottom: 16px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .modal-wine-name {
    font-family: var(--font-serif);
    font-size: 28px;
    font-weight: 300;
    font-style: italic;
    color: var(--cream);
    line-height: 1.2;
  }
  .modal-producer { font-size: 11px; color: var(--text-dim); margin-top: 3px; letter-spacing: 0.05em; }

  .modal-body { padding: 0 24px 24px; }

  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }
  .detail-item { }
  .detail-label { font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
  .detail-value { font-size: 14px; color: var(--cream); font-family: var(--font-serif); }
  .detail-value.gold { color: var(--gold); }
  .detail-value.green { color: var(--green); }

  .notes-box {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    font-size: 12px;
    color: var(--cream-dim);
    line-height: 1.7;
    margin-bottom: 16px;
    font-family: var(--font-serif);
    font-style: italic;
  }

  .modal-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  /* ===========================
     STATS VIEW
  =========================== */
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    text-align: center;
  }
  .stat-number {
    font-family: var(--font-serif);
    font-size: 48px;
    font-weight: 300;
    color: var(--gold);
    line-height: 1;
    margin-bottom: 6px;
  }
  .stat-label { font-size: 9px; letter-spacing: 0.2em; color: var(--text-muted); text-transform: uppercase; }

  .bar-chart { margin-top: 16px; }
  .bar-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .bar-label { font-size: 10px; color: var(--text-dim); width: 70px; text-align: right; letter-spacing: 0.05em; }
  .bar-track { flex: 1; height: 6px; background: var(--bg3); border-radius: 3px; overflow: hidden; }
  .bar-fill { height: 100%; background: var(--wine); border-radius: 3px; transition: width 0.6s ease; }
  .bar-fill.gold { background: var(--gold); }
  .bar-fill.rose { background: #c47080; }
  .bar-fill.sparkling { background: #8080c4; }
  .bar-fill.orange { background: #c47030; }
  .bar-count { font-size: 10px; color: var(--text-muted); width: 24px; }

  /* ===========================
     RACK CONFIG MODAL
  =========================== */
  .rack-config-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .rack-config-item:last-child { border-bottom: none; }
  .rack-name-input { flex: 1; }

  /* TOASTS */
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 500;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    background: var(--surface2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 10px 16px;
    font-size: 11px;
    color: var(--cream);
    letter-spacing: 0.05em;
    animation: slideIn 0.2s ease;
    max-width: 280px;
  }
  .toast.success { border-color: var(--green); }
  .toast.error { border-color: var(--wine-light); }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* Pending sync badge */
  .pending-badge {
    background: var(--gold);
    color: var(--bg);
    border-radius: 10px;
    font-size: 8px;
    padding: 1px 5px;
    font-family: var(--font-mono);
    font-weight: 500;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  @media (max-width: 600px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .detail-grid { grid-template-columns: 1fr 1fr; }
    header { padding: 0 14px; }
    main { padding: 16px 14px; }
    .bottle-grid { grid-template-columns: 1fr 1fr; }
    nav { padding: 0 8px; overflow-x: auto; }
    .nav-tab { padding: 10px 12px; }
  }
</style>
</head>
<body>
<div id="app">

<header>
  <div>
    <div class="logo">cave <span>wine cellar</span></div>
  </div>
  <div class="header-actions">
    <div class="sync-indicator">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-label">OFFLINE</span>
      <span id="pending-count" class="pending-badge" style="display:none">0</span>
    </div>
  </div>
</header>

<nav>
  <button class="nav-tab active" data-view="collection">Collection</button>
  <button class="nav-tab" data-view="add">Add Bottle</button>
  <button class="nav-tab" data-view="cellar">Cellar Map</button>
  <button class="nav-tab" data-view="stats">Statistics</button>
</nav>

<main>

  <!-- COLLECTION -->
  <div class="view active" id="view-collection">
    <div class="section-header">
      <div class="section-title">My Collection</div>
      <span class="section-count" id="bottle-count">0 bottles</span>
    </div>
    <div id="search-bar">
      <input type="text" id="search-input" placeholder="Search by name, producer, varietal‚Ä¶">
      <button class="btn btn-sm" onclick="openSortMenu()">‚Üï Sort</button>
    </div>
    <div class="filter-row" id="filter-row">
      <button class="filter-chip active" data-filter="all">All</button>
      <button class="filter-chip" data-filter="red">Red</button>
      <button class="filter-chip" data-filter="white">White</button>
      <button class="filter-chip" data-filter="ros√©">Ros√©</button>
      <button class="filter-chip" data-filter="sparkling">Sparkling</button>
      <button class="filter-chip" data-filter="orange">Orange</button>
    </div>
    <div class="bottle-grid" id="bottle-grid"></div>
    <div id="empty-collection" class="empty-state" style="display:none">
      <span class="es-icon">üç∑</span>
      <h3>Your cellar awaits</h3>
      <p>Add your first bottle to begin tracking<br>your collection.</p>
    </div>
  </div>

  <!-- ADD BOTTLE -->
  <div class="view" id="view-add">
    <div class="section-header">
      <div class="section-title">Add a Bottle</div>
    </div>

    <!-- Scanner -->
    <div id="scan-area" onclick="toggleScanner()">
      <div class="scan-icon">üì∑</div>
      <div class="scan-hint">TAP TO SCAN BARCODE</div>
      <video id="scanner-video" autoplay muted playsinline></video>
      <canvas id="scan-canvas" style="display:none"></canvas>
    </div>

    <div class="or-divider">or search manually</div>

    <div class="form-section">
      <div class="form-section-title">Wine Details</div>
      <div class="field">
        <label>Search by name or producer</label>
        <input type="text" id="wine-search" placeholder="e.g. Ch√¢teauneuf-du-Pape, Penfolds‚Ä¶" oninput="handleWineSearch(this.value)">
        <div class="search-results" id="search-results"></div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Wine Name / Cuv√©e</label>
          <input type="text" id="f-name" placeholder="e.g. Ch√¢teau Margaux">
        </div>
        <div class="field">
          <label>Producer</label>
          <input type="text" id="f-producer" placeholder="e.g. Ch√¢teau Margaux">
        </div>
      </div>
      <div class="grid-3">
        <div class="field">
          <label>Vintage</label>
          <input type="number" id="f-vintage" placeholder="2019" min="1800" max="2030">
        </div>
        <div class="field">
          <label>Varietal</label>
          <input type="text" id="f-varietal" placeholder="e.g. Cabernet Sauvignon">
        </div>
        <div class="field">
          <label>Type</label>
          <select id="f-type">
            <option value="red">Red</option>
            <option value="white">White</option>
            <option value="ros√©">Ros√©</option>
            <option value="sparkling">Sparkling</option>
            <option value="orange">Orange</option>
            <option value="dessert">Dessert</option>
            <option value="fortified">Fortified</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Region / Appellation</label>
          <input type="text" id="f-region" placeholder="e.g. Bordeaux, Napa Valley">
        </div>
        <div class="field">
          <label>Country</label>
          <input type="text" id="f-country" placeholder="e.g. France">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Acquisition & Pricing</div>
      <div class="grid-3">
        <div class="field">
          <label>Purchase Price ($)</label>
          <input type="number" id="f-purchase-price" placeholder="0.00" step="0.01">
        </div>
        <div class="field">
          <label>Market Value ($)</label>
          <input type="number" id="f-market-value" placeholder="0.00" step="0.01">
        </div>
        <div class="field">
          <label>Quantity</label>
          <input type="number" id="f-quantity" placeholder="1" min="1" value="1">
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Date Acquired</label>
          <input type="date" id="f-date">
        </div>
        <div class="field">
          <label>Drink By / Peak</label>
          <input type="text" id="f-drink-by" placeholder="e.g. 2025‚Äì2035">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Cellar Location</div>
      <div class="grid-2">
        <div class="field">
          <label>Rack</label>
          <select id="f-rack"></select>
        </div>
        <div class="field">
          <label>Slot (Row √ó Col)</label>
          <div style="display:flex;gap:6px">
            <input type="number" id="f-row" placeholder="Row" min="1" style="width:50%">
            <input type="number" id="f-col" placeholder="Col" min="1" style="width:50%">
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Ratings & Notes</div>
      <div class="grid-2">
        <div class="field">
          <label>Score (0‚Äì100)</label>
          <input type="number" id="f-score" placeholder="e.g. 92" min="0" max="100">
        </div>
        <div class="field">
          <label>Critic / Source</label>
          <input type="text" id="f-critic" placeholder="e.g. Wine Spectator">
        </div>
      </div>
      <div class="field">
        <label>Tasting Notes</label>
        <textarea id="f-notes" rows="3" placeholder="Aromas, palate, finish‚Ä¶"></textarea>
      </div>
      <div class="field">
        <label>Personal Notes</label>
        <textarea id="f-personal" rows="2" placeholder="Where you bought it, occasion‚Ä¶"></textarea>
      </div>
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" onclick="clearForm()">Clear</button>
      <button class="btn btn-primary" onclick="addBottle()">Add to Cellar</button>
    </div>
  </div>

  <!-- CELLAR MAP -->
  <div class="view" id="view-cellar">
    <div class="section-header">
      <div class="section-title">Cellar Map</div>
      <button class="btn btn-sm btn-gold" onclick="openRackConfig()">‚öô Manage Racks</button>
    </div>

    <div class="rack-controls">
      <div class="rack-selector" id="rack-selector"></div>
    </div>

    <div id="rack-grid-wrap">
      <div id="rack-col-labels" style="display:flex;gap:4px;margin-bottom:4px;padding-left:36px"></div>
      <div style="display:flex;gap:4px">
        <div id="rack-row-labels" style="display:flex;flex-direction:column;gap:4px;justify-content:flex-start;"></div>
        <div id="rack-grid"></div>
      </div>
    </div>

    <div class="rack-legend">
      <div class="legend-item"><div class="legend-dot" style="background:rgba(139,26,26,0.4);border:1px solid #8b1a1a"></div> Red</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(196,149,42,0.3);border:1px solid #c4952a"></div> White</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(196,112,128,0.3);border:1px solid #c47080"></div> Ros√©</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(128,128,196,0.3);border:1px solid #8080c4"></div> Sparkling</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(196,112,48,0.3);border:1px solid #c47030"></div> Orange</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--bg2);border:1px solid var(--border)"></div> Empty</div>
    </div>
  </div>

  <!-- STATS -->
  <div class="view" id="view-stats">
    <div class="section-header">
      <div class="section-title">Statistics</div>
    </div>

    <div class="grid-3" style="margin-bottom:20px">
      <div class="stat-card">
        <div class="stat-number" id="stat-total">0</div>
        <div class="stat-label">Total Bottles</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-value" style="font-size:32px">$0</div>
        <div class="stat-label">Est. Value</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-avg-score">‚Äî</div>
        <div class="stat-label">Avg Score</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="form-section-title" style="margin-bottom:14px">By Type</div>
        <div class="bar-chart" id="chart-type"></div>
      </div>
      <div class="card">
        <div class="form-section-title" style="margin-bottom:14px">By Vintage Decade</div>
        <div class="bar-chart" id="chart-decade"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="form-section-title" style="margin-bottom:14px">By Region</div>
      <div class="bar-chart" id="chart-region"></div>
    </div>
  </div>

</main>
</div>

<!-- BOTTLE DETAIL MODAL -->
<div class="modal-overlay" id="bottle-modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-wine-name" id="m-name">‚Äî</div>
        <div class="modal-producer" id="m-producer">‚Äî</div>
      </div>
      <button class="btn btn-sm btn-icon" onclick="closeModal('bottle-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid">
        <div class="detail-item"><div class="detail-label">Vintage</div><div class="detail-value" id="m-vintage">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Type</div><div class="detail-value" id="m-type">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Varietal</div><div class="detail-value" id="m-varietal">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Region</div><div class="detail-value" id="m-region">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Score</div><div class="detail-value gold" id="m-score">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Market Value</div><div class="detail-value green" id="m-value">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Location</div><div class="detail-value" id="m-location">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Drink Window</div><div class="detail-value" id="m-drink">‚Äî</div></div>
      </div>
      <div id="m-notes-wrap" style="display:none">
        <label style="margin-bottom:6px">Tasting Notes</label>
        <div class="notes-box" id="m-notes"></div>
      </div>
      <div id="m-personal-wrap" style="display:none">
        <label style="margin-bottom:6px">Personal Notes</label>
        <div class="notes-box" id="m-personal" style="font-style:normal;font-family:var(--font-mono);font-size:11px"></div>
      </div>
      <div id="m-sync-status" style="font-size:10px;color:var(--text-muted);margin-bottom:12px;"></div>
      <div class="modal-actions">
        <button class="btn btn-sm btn-gold" onclick="syncBottle(currentBottleId)">‚Üª Fetch Data</button>
        <button class="btn btn-sm" onclick="editBottleModal(currentBottleId)">‚úè Edit</button>
        <button class="btn btn-sm" style="margin-left:auto;border-color:var(--wine);color:var(--wine-light)" onclick="removeBottle(currentBottleId)">Remove</button>
      </div>
    </div>
  </div>
</div>

<!-- RACK CONFIG MODAL -->
<div class="modal-overlay" id="rack-modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-wine-name">Manage Racks</div>
        <div class="modal-producer">Configure your cellar shelving</div>
      </div>
      <button class="btn btn-sm btn-icon" onclick="closeModal('rack-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="rack-config-list"></div>
      <div style="display:flex;gap:10px;margin-top:16px;align-items:flex-end">
        <div class="field" style="flex:2;margin:0">
          <label>Rack Name</label>
          <input type="text" id="new-rack-name" placeholder="e.g. Basement Rack A">
        </div>
        <div class="field" style="flex:1;margin:0">
          <label>Rows</label>
          <input type="number" id="new-rack-rows" value="6" min="1" max="30">
        </div>
        <div class="field" style="flex:1;margin:0">
          <label>Cols</label>
          <input type="number" id="new-rack-cols" value="12" min="1" max="50">
        </div>
        <button class="btn btn-primary btn-sm" onclick="addRack()" style="height:34px;align-self:flex-end">+ Add</button>
      </div>
    </div>
  </div>
</div>

<!-- Slot tooltip -->
<div class="slot-tooltip" id="slot-tooltip">
  <div class="st-name" id="tt-name"></div>
  <div class="st-meta" id="tt-meta"></div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
<script>
// ===========================
// DATABASE (IndexedDB via Dexie)
// ===========================
const db = new Dexie('CaveWineCellar');
db.version(2).stores({
  bottles: '++id, name, producer, vintage, type, varietal, region, rack, row, col, synced, addedAt',
  racks: '++id, name, rows, cols',
  syncQueue: '++id, bottleId, action, timestamp'
});

// ===========================
// STATE
// ===========================
let bottles = [];
let racks = [];
let currentFilter = 'all';
let currentSort = 'addedAt';
let currentRackId = null;
let currentBottleId = null;
let scannerActive = false;
let scannerStream = null;
let searchDebounce = null;

// ===========================
// INIT
// ===========================
async function init() {
  await loadRacks();
  await loadBottles();
  renderCollection();
  renderStats();
  setupNav();
  setupFilters();
  updateSyncStatus();
  window.addEventListener('online', () => { updateSyncStatus(); processSyncQueue(); });
  window.addEventListener('offline', updateSyncStatus);

  // Set today's date
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
}

// ===========================
// NAV
// ===========================
function setupNav() {
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('view-' + tab.dataset.view).classList.add('active');
      if (tab.dataset.view === 'cellar') renderCellar();
      if (tab.dataset.view === 'stats') renderStats();
      if (tab.dataset.view === 'add') populateRackSelect();
    });
  });
}

// ===========================
// RACKS
// ===========================
async function loadRacks() {
  racks = await db.racks.toArray();
  if (racks.length === 0) {
    // Default rack
    const id = await db.racks.add({ name: 'Main Rack', rows: 6, cols: 12 });
    racks = await db.racks.toArray();
  }
  currentRackId = racks[0].id;
}

async function addRack() {
  const name = document.getElementById('new-rack-name').value.trim() || 'New Rack';
  const rows = parseInt(document.getElementById('new-rack-rows').value) || 6;
  const cols = parseInt(document.getElementById('new-rack-cols').value) || 12;
  await db.racks.add({ name, rows, cols });
  racks = await db.racks.toArray();
  renderRackConfig();
  populateRackSelect();
  renderCellarTabs();
  toast('Rack added');
}

async function removeRack(id) {
  if (racks.length <= 1) { toast('Cannot remove last rack', 'error'); return; }
  await db.racks.delete(id);
  racks = await db.racks.toArray();
  if (currentRackId === id) currentRackId = racks[0].id;
  renderRackConfig();
  renderCellarTabs();
  renderCellar();
}

function openRackConfig() {
  renderRackConfig();
  document.getElementById('rack-modal').classList.add('open');
}

function renderRackConfig() {
  const list = document.getElementById('rack-config-list');
  list.innerHTML = racks.map(r => `
    <div class="rack-config-item">
      <span style="flex:2;font-size:13px;color:var(--cream)">${r.name}</span>
      <span style="font-size:10px;color:var(--text-muted)">${r.rows}R √ó ${r.cols}C</span>
      <button class="btn btn-sm" style="border-color:var(--wine);color:var(--wine-light)" onclick="removeRack(${r.id})">Remove</button>
    </div>
  `).join('') || '<div style="color:var(--text-muted);font-size:11px;padding:10px 0">No racks configured</div>';
}

function populateRackSelect() {
  const sel = document.getElementById('f-rack');
  sel.innerHTML = racks.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
}

// ===========================
// BOTTLES - LOAD
// ===========================
async function loadBottles() {
  bottles = await db.bottles.orderBy('addedAt').reverse().toArray();
}

// ===========================
// COLLECTION RENDER
// ===========================
function renderCollection() {
  const query = document.getElementById('search-input').value.toLowerCase();
  let filtered = bottles.filter(b => {
    const matchFilter = currentFilter === 'all' || b.type === currentFilter || b.type === currentFilter.replace('√©', 'e');
    const matchSearch = !query ||
      (b.name || '').toLowerCase().includes(query) ||
      (b.producer || '').toLowerCase().includes(query) ||
      (b.varietal || '').toLowerCase().includes(query) ||
      (b.region || '').toLowerCase().includes(query);
    return matchFilter && matchSearch;
  });

  // Sort
  filtered.sort((a, b) => {
    if (currentSort === 'vintage') return (b.vintage || 0) - (a.vintage || 0);
    if (currentSort === 'name') return (a.name || '').localeCompare(b.name || '');
    if (currentSort === 'score') return (b.score || 0) - (a.score || 0);
    return new Date(b.addedAt) - new Date(a.addedAt);
  });

  const grid = document.getElementById('bottle-grid');
  const empty = document.getElementById('empty-collection');
  const count = document.getElementById('bottle-count');
  count.textContent = `${bottles.length} bottle${bottles.length !== 1 ? 's' : ''}`;

  if (filtered.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  grid.innerHTML = filtered.map(b => `
    <div class="bottle-card ${b.type || ''}" onclick="openBottle(${b.id})">
      <div class="bottle-name">${b.name || 'Unnamed Wine'}</div>
      <div class="bottle-producer">${b.producer || '‚Äî'}</div>
      <div class="bottle-meta">
        ${b.vintage ? `<span class="tag vintage">${b.vintage}</span>` : ''}
        ${b.varietal ? `<span class="tag varietal">${b.varietal}</span>` : ''}
      </div>
      <div class="bottle-footer">
        <span class="bottle-location">${getLocationStr(b)}</span>
        <span>${b.score ? `<span class="bottle-rating">${b.score}</span>` : ''}${b.marketValue ? `<span class="bottle-price">$${b.marketValue}</span>` : ''}</span>
      </div>
    </div>
  `).join('');
}

function getLocationStr(b) {
  if (!b.rack && !b.row && !b.col) return 'No location';
  const rack = racks.find(r => r.id == b.rack);
  const rName = rack ? rack.name : 'Rack';
  if (b.row && b.col) return `${rName} ¬∑ R${b.row}C${b.col}`;
  return rName;
}

function setupFilters() {
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      currentFilter = chip.dataset.filter;
      renderCollection();
    });
  });
  document.getElementById('search-input').addEventListener('input', renderCollection);
}

function openSortMenu() {
  const opts = ['addedAt', 'vintage', 'name', 'score'];
  const labels = { addedAt: 'Date Added', vintage: 'Vintage', name: 'Name', score: 'Score' };
  const cur = opts[(opts.indexOf(currentSort) + 1) % opts.length];
  currentSort = cur;
  toast('Sorted by: ' + labels[cur]);
  renderCollection();
}

// ===========================
// BOTTLE DETAIL
// ===========================
async function openBottle(id) {
  const b = await db.bottles.get(id);
  if (!b) return;
  currentBottleId = id;
  document.getElementById('m-name').textContent = b.name || '‚Äî';
  document.getElementById('m-producer').textContent = b.producer || '‚Äî';
  document.getElementById('m-vintage').textContent = b.vintage || '‚Äî';
  document.getElementById('m-type').textContent = capitalize(b.type || '‚Äî');
  document.getElementById('m-varietal').textContent = b.varietal || '‚Äî';
  document.getElementById('m-region').textContent = [b.region, b.country].filter(Boolean).join(', ') || '‚Äî';
  document.getElementById('m-score').textContent = b.score ? `${b.score}${b.critic ? ' ¬∑ ' + b.critic : ''}` : '‚Äî';
  document.getElementById('m-value').textContent = b.marketValue ? `$${b.marketValue}` : '‚Äî';
  document.getElementById('m-location').textContent = getLocationStr(b);
  document.getElementById('m-drink').textContent = b.drinkBy || '‚Äî';

  const notesWrap = document.getElementById('m-notes-wrap');
  if (b.notes) { notesWrap.style.display = 'block'; document.getElementById('m-notes').textContent = b.notes; }
  else notesWrap.style.display = 'none';

  const personalWrap = document.getElementById('m-personal-wrap');
  if (b.personal) { personalWrap.style.display = 'block'; document.getElementById('m-personal').textContent = b.personal; }
  else personalWrap.style.display = 'none';

  const syncEl = document.getElementById('m-sync-status');
  if (b.synced) syncEl.textContent = '‚úì Data synced from open sources';
  else if (!navigator.onLine) syncEl.textContent = '‚ö† Offline ‚Äî enrichment pending';
  else syncEl.textContent = '';

  document.getElementById('bottle-modal').classList.add('open');
}

async function removeBottle(id) {
  if (!confirm('Remove this bottle from your cellar?')) return;
  await db.bottles.delete(id);
  closeModal('bottle-modal');
  await loadBottles();
  renderCollection();
  renderStats();
  toast('Bottle removed');
}

function editBottleModal(id) {
  closeModal('bottle-modal');
  const b = bottles.find(x => x.id === id);
  if (!b) return;
  // Switch to add tab and populate
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelector('[data-view="add"]').classList.add('active');
  document.getElementById('view-add').classList.add('active');
  populateForm(b);
  // Store edit id
  document.getElementById('f-name').dataset.editId = id;
}

function populateForm(b) {
  document.getElementById('f-name').value = b.name || '';
  document.getElementById('f-producer').value = b.producer || '';
  document.getElementById('f-vintage').value = b.vintage || '';
  document.getElementById('f-varietal').value = b.varietal || '';
  document.getElementById('f-type').value = b.type || 'red';
  document.getElementById('f-region').value = b.region || '';
  document.getElementById('f-country').value = b.country || '';
  document.getElementById('f-purchase-price').value = b.purchasePrice || '';
  document.getElementById('f-market-value').value = b.marketValue || '';
  document.getElementById('f-quantity').value = b.quantity || 1;
  document.getElementById('f-drink-by').value = b.drinkBy || '';
  document.getElementById('f-score').value = b.score || '';
  document.getElementById('f-critic').value = b.critic || '';
  document.getElementById('f-notes').value = b.notes || '';
  document.getElementById('f-personal').value = b.personal || '';
  populateRackSelect();
  if (b.rack) document.getElementById('f-rack').value = b.rack;
  document.getElementById('f-row').value = b.row || '';
  document.getElementById('f-col').value = b.col || '';
}

// ===========================
// ADD BOTTLE
// ===========================
async function addBottle() {
  const nameEl = document.getElementById('f-name');
  const editId = nameEl.dataset.editId ? parseInt(nameEl.dataset.editId) : null;

  const bottle = {
    name: document.getElementById('f-name').value.trim(),
    producer: document.getElementById('f-producer').value.trim(),
    vintage: parseInt(document.getElementById('f-vintage').value) || null,
    varietal: document.getElementById('f-varietal').value.trim(),
    type: document.getElementById('f-type').value,
    region: document.getElementById('f-region').value.trim(),
    country: document.getElementById('f-country').value.trim(),
    purchasePrice: parseFloat(document.getElementById('f-purchase-price').value) || null,
    marketValue: parseFloat(document.getElementById('f-market-value').value) || null,
    quantity: parseInt(document.getElementById('f-quantity').value) || 1,
    drinkBy: document.getElementById('f-drink-by').value.trim(),
    rack: parseInt(document.getElementById('f-rack').value) || null,
    row: parseInt(document.getElementById('f-row').value) || null,
    col: parseInt(document.getElementById('f-col').value) || null,
    score: parseInt(document.getElementById('f-score').value) || null,
    critic: document.getElementById('f-critic').value.trim(),
    notes: document.getElementById('f-notes').value.trim(),
    personal: document.getElementById('f-personal').value.trim(),
    synced: false,
    addedAt: new Date().toISOString()
  };

  if (!bottle.name) { toast('Please enter a wine name', 'error'); return; }

  if (editId) {
    await db.bottles.update(editId, bottle);
    delete nameEl.dataset.editId;
    toast('Bottle updated');
  } else {
    const id = await db.bottles.add(bottle);
    // Queue sync
    await db.syncQueue.add({ bottleId: id, action: 'enrich', timestamp: new Date().toISOString() });
    toast('Bottle added to cellar');
    // Try immediate sync if online
    if (navigator.onLine) syncBottle(id);
  }

  clearForm();
  await loadBottles();
  renderCollection();
  renderStats();
  renderCellar();
}

function clearForm() {
  ['f-name','f-producer','f-vintage','f-varietal','f-region','f-country',
   'f-purchase-price','f-market-value','f-drink-by','f-score','f-critic','f-notes','f-personal',
   'f-row','f-col'].forEach(id => { document.getElementById(id).value = ''; });
  document.getElementById('f-quantity').value = 1;
  document.getElementById('f-type').value = 'red';
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
  delete document.getElementById('f-name').dataset.editId;
}

// ===========================
// WINE SEARCH (Open Wine API / Open Food Facts)
// ===========================
async function handleWineSearch(query) {
  clearTimeout(searchDebounce);
  const results = document.getElementById('search-results');
  if (query.length < 3) { results.style.display = 'none'; return; }

  searchDebounce = setTimeout(async () => {
    if (!navigator.onLine) {
      results.style.display = 'none';
      toast('Offline ‚Äî search unavailable');
      return;
    }
    results.style.display = 'block';
    results.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">Searching‚Ä¶</div>';

    try {
      // Open Food Facts wine search
      const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&categories_tags=wines&json=1&page_size=8&fields=product_name,brands,ingredients_text,nutrition_grades,quantity`;
      const resp = await fetch(url);
      const data = await resp.json();
      const products = (data.products || []).filter(p => p.product_name);

      if (products.length === 0) {
        results.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">No results found</div>';
        return;
      }

      results.innerHTML = products.slice(0, 8).map(p => `
        <div class="search-result-item" onclick="selectWineResult(${JSON.stringify({
          name: p.product_name,
          producer: p.brands || '',
          notes: p.ingredients_text || ''
        }).replace(/"/g,'&quot;')})">
          <div class="sri-name">${p.product_name}</div>
          <div class="sri-meta">${p.brands || 'Unknown producer'}${p.quantity ? ' ¬∑ ' + p.quantity : ''}</div>
        </div>
      `).join('');
    } catch(e) {
      results.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">Search unavailable</div>';
    }
  }, 400);
}

function selectWineResult(data) {
  document.getElementById('f-name').value = data.name || '';
  document.getElementById('f-producer').value = data.producer || '';
  if (data.notes) document.getElementById('f-notes').value = data.notes;
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('wine-search').value = '';
}

// ===========================
// SYNC / ENRICH
// ===========================
async function syncBottle(id) {
  if (!navigator.onLine) { toast('Offline ‚Äî will sync when connected'); return; }
  const b = await db.bottles.get(id);
  if (!b) return;

  toast('Fetching wine data‚Ä¶');
  let enriched = {};

  // Try Open Food Facts barcode or name search
  try {
    const query = [b.name, b.producer, b.vintage].filter(Boolean).join(' ');
    const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&categories_tags=wines&json=1&page_size=1&fields=product_name,brands,ingredients_text,origins,countries`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.products && data.products[0]) {
      const p = data.products[0];
      enriched.country = enriched.country || p.countries || b.country;
      enriched.region = enriched.region || p.origins || b.region;
      if (p.ingredients_text && !b.notes) enriched.notes = p.ingredients_text;
    }
  } catch(e) {}

  enriched.synced = true;
  await db.bottles.update(id, enriched);
  await db.syncQueue.where('bottleId').equals(id).delete();
  await loadBottles();
  renderCollection();
  toast('Wine data updated ‚úì', 'success');
}

async function processSyncQueue() {
  const queue = await db.syncQueue.toArray();
  for (const item of queue) {
    await syncBottle(item.bottleId);
  }
  updatePendingCount();
}

async function updatePendingCount() {
  const count = await db.syncQueue.count();
  const badge = document.getElementById('pending-count');
  if (count > 0) { badge.textContent = count; badge.style.display = 'inline'; }
  else badge.style.display = 'none';
}

// ===========================
// BARCODE SCANNER
// ===========================
async function toggleScanner() {
  if (scannerActive) {
    stopScanner();
    return;
  }
  const area = document.getElementById('scan-area');
  const video = document.getElementById('scanner-video');
  try {
    scannerStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = scannerStream;
    video.style.display = 'block';
    area.classList.add('active');
    area.querySelector('.scan-icon').style.display = 'none';
    area.querySelector('.scan-hint').textContent = 'SCANNING‚Ä¶ TAP TO STOP';
    scannerActive = true;
    scanFrame();
  } catch(e) {
    toast('Camera access denied or unavailable', 'error');
  }
}

function stopScanner() {
  if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }
  const video = document.getElementById('scanner-video');
  video.style.display = 'none';
  const area = document.getElementById('scan-area');
  area.classList.remove('active');
  area.querySelector('.scan-icon').style.display = 'block';
  area.querySelector('.scan-hint').textContent = 'TAP TO SCAN BARCODE';
  scannerActive = false;
}

function scanFrame() {
  if (!scannerActive) return;
  const video = document.getElementById('scanner-video');
  const canvas = document.getElementById('scan-canvas');
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    // Use BarcodeDetector if available
    if ('BarcodeDetector' in window) {
      const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e'] });
      detector.detect(canvas).then(barcodes => {
        if (barcodes.length > 0) {
          handleBarcode(barcodes[0].rawValue);
        }
      }).catch(() => {});
    }
  }
  if (scannerActive) requestAnimationFrame(scanFrame);
}

async function handleBarcode(code) {
  stopScanner();
  toast('Barcode: ' + code + ' ‚Äî looking up‚Ä¶');
  if (!navigator.onLine) {
    toast('Offline ‚Äî enter details manually', 'error');
    return;
  }
  try {
    // Open Food Facts barcode lookup
    const resp = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
    const data = await resp.json();
    if (data.status === 1 && data.product) {
      const p = data.product;
      document.getElementById('f-name').value = p.product_name || '';
      document.getElementById('f-producer').value = p.brands || '';
      document.getElementById('f-country').value = p.countries || '';
      document.getElementById('f-region').value = p.origins || '';
      if (p.ingredients_text) document.getElementById('f-notes').value = p.ingredients_text;
      toast('Product found and populated ‚úì', 'success');
    } else {
      toast('Product not found ‚Äî enter details manually');
    }
  } catch(e) {
    toast('Lookup failed ‚Äî enter details manually', 'error');
  }
}

// ===========================
// CELLAR MAP
// ===========================
function renderCellarTabs() {
  const sel = document.getElementById('rack-selector');
  sel.innerHTML = racks.map(r => `
    <button class="rack-tab ${r.id === currentRackId ? 'active' : ''}" onclick="selectRack(${r.id})">${r.name}</button>
  `).join('');
}

function selectRack(id) {
  currentRackId = id;
  renderCellarTabs();
  renderCellar();
}

function renderCellar() {
  renderCellarTabs();
  const rack = racks.find(r => r.id === currentRackId);
  if (!rack) return;

  const grid = document.getElementById('rack-grid');
  const colLabels = document.getElementById('rack-col-labels');
  const rowLabels = document.getElementById('rack-row-labels');

  grid.style.gridTemplateColumns = `repeat(${rack.cols}, 44px)`;
  grid.style.gridTemplateRows = `repeat(${rack.rows}, 44px)`;

  // Column labels
  colLabels.innerHTML = Array.from({length: rack.cols}, (_,i) =>
    `<div style="width:44px;text-align:center;font-size:9px;color:var(--text-muted);letter-spacing:0">${i+1}</div>`
  ).join('');

  // Row labels
  rowLabels.innerHTML = Array.from({length: rack.rows}, (_,i) =>
    `<div style="height:44px;width:28px;display:flex;align-items:center;justify-content:flex-end;font-size:9px;color:var(--text-muted);letter-spacing:0">${i+1}</div>`
  ).join('');

  // Build slot map
  const slotMap = {};
  bottles.forEach(b => {
    if (b.rack == currentRackId && b.row && b.col) {
      slotMap[`${b.row}-${b.col}`] = b;
    }
  });

  grid.innerHTML = '';
  for (let r = 1; r <= rack.rows; r++) {
    for (let c = 1; c <= rack.cols; c++) {
      const key = `${r}-${c}`;
      const b = slotMap[key];
      const slot = document.createElement('div');
      slot.className = `rack-slot${b ? ' occupied ' + (b.type || '') : ''}`;
      slot.innerHTML = `<div class="rack-slot-dot"></div>`;
      slot.dataset.row = r;
      slot.dataset.col = c;
      if (b) {
        slot.addEventListener('mouseenter', (e) => showTooltip(e, b));
        slot.addEventListener('mouseleave', hideTooltip);
        slot.addEventListener('click', () => openBottle(b.id));
      } else {
        slot.addEventListener('click', () => assignSlot(r, c));
        slot.title = `R${r}C${c} ‚Äî Empty`;
      }
      grid.appendChild(slot);
    }
  }
}

function showTooltip(e, b) {
  const tt = document.getElementById('slot-tooltip');
  document.getElementById('tt-name').textContent = b.name || 'Unknown';
  document.getElementById('tt-meta').textContent = [b.vintage, capitalize(b.type), b.varietal].filter(Boolean).join(' ¬∑ ');
  tt.classList.add('visible');
  moveTooltip(e);
}

function moveTooltip(e) {
  const tt = document.getElementById('slot-tooltip');
  tt.style.left = (e.clientX + 12) + 'px';
  tt.style.top = (e.clientY - 30) + 'px';
}

function hideTooltip() {
  document.getElementById('slot-tooltip').classList.remove('visible');
}

function assignSlot(row, col) {
  // Switch to add tab with location pre-filled
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelector('[data-view="add"]').classList.add('active');
  document.getElementById('view-add').classList.add('active');
  populateRackSelect();
  document.getElementById('f-rack').value = currentRackId;
  document.getElementById('f-row').value = row;
  document.getElementById('f-col').value = col;
  toast(`Pre-filled location: R${row}C${col}`);
}

// ===========================
// STATS
// ===========================
function renderStats() {
  const total = bottles.length;
  document.getElementById('stat-total').textContent = total;

  const totalValue = bottles.reduce((s, b) => s + (b.marketValue || b.purchasePrice || 0), 0);
  document.getElementById('stat-value').textContent = totalValue ? '$' + totalValue.toLocaleString(undefined, {maximumFractionDigits:0}) : '‚Äî';

  const scores = bottles.filter(b => b.score).map(b => b.score);
  const avgScore = scores.length ? Math.round(scores.reduce((a,b) => a+b, 0) / scores.length) : null;
  document.getElementById('stat-avg-score').textContent = avgScore || '‚Äî';

  // By type
  const types = ['red','white','ros√©','sparkling','orange','dessert','fortified'];
  const typeColors = { red:'', white:'gold', ros√©:'rose', sparkling:'sparkling', orange:'orange' };
  const typeCounts = {};
  types.forEach(t => typeCounts[t] = bottles.filter(b => b.type === t).length);
  const maxType = Math.max(...Object.values(typeCounts), 1);
  document.getElementById('chart-type').innerHTML = types.filter(t => typeCounts[t] > 0).map(t => `
    <div class="bar-row">
      <div class="bar-label">${capitalize(t)}</div>
      <div class="bar-track"><div class="bar-fill ${typeColors[t] || ''}" style="width:${(typeCounts[t]/maxType)*100}%"></div></div>
      <div class="bar-count">${typeCounts[t]}</div>
    </div>
  `).join('') || '<div style="color:var(--text-muted);font-size:11px">No data</div>';

  // By decade
  const decades = {};
  bottles.filter(b => b.vintage).forEach(b => {
    const d = Math.floor(b.vintage / 10) * 10;
    decades[d] = (decades[d] || 0) + 1;
  });
  const maxDec = Math.max(...Object.values(decades), 1);
  document.getElementById('chart-decade').innerHTML = Object.entries(decades).sort((a,b) => b[0]-a[0]).map(([d,c]) => `
    <div class="bar-row">
      <div class="bar-label">${d}s</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(c/maxDec)*100}%"></div></div>
      <div class="bar-count">${c}</div>
    </div>
  `).join('') || '<div style="color:var(--text-muted);font-size:11px">No vintage data</div>';

  // By region
  const regions = {};
  bottles.filter(b => b.region).forEach(b => {
    regions[b.region] = (regions[b.region] || 0) + 1;
  });
  const maxReg = Math.max(...Object.values(regions), 1);
  document.getElementById('chart-region').innerHTML = Object.entries(regions).sort((a,b) => b[1]-a[1]).slice(0,8).map(([r,c]) => `
    <div class="bar-row">
      <div class="bar-label" style="width:100px;font-size:9px">${r}</div>
      <div class="bar-track"><div class="bar-fill gold" style="width:${(c/maxReg)*100}%"></div></div>
      <div class="bar-count">${c}</div>
    </div>
  `).join('') || '<div style="color:var(--text-muted);font-size:11px">No region data</div>';
}

// ===========================
// SYNC STATUS
// ===========================
function updateSyncStatus() {
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-label');
  if (navigator.onLine) {
    dot.className = 'sync-dot online';
    label.textContent = 'ONLINE';
    updatePendingCount();
  } else {
    dot.className = 'sync-dot';
    label.textContent = 'OFFLINE';
    updatePendingCount();
  }
}

// ===========================
// MODAL
// ===========================
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ===========================
// TOAST
// ===========================
function toast(msg, type = '') {
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ===========================
// UTILS
// ===========================
function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

// ===========================
// SERVICE WORKER
// ===========================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(() => {});
}

// ===========================
// START
// ===========================
init();
</script>
</body>
</html>
