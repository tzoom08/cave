<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a0a00">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Cave ‚Äî Wine Cellar</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Inconsolata:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f7f4f0;
    --bg2: #ffffff;
    --bg3: #f0ece6;
    --surface: #e8e2d8;
    --surface2: #ddd6c8;
    --border: #d4c8b8;
    --border-light: #bfb0a0;
    --wine: #8b1a1a;
    --wine-light: #c42b2b;
    --gold: #9a6e1a;
    --gold-light: #c49030;
    --cream: #1a120a;
    --cream-dim: #4a3828;
    --text: #1a120a;
    --text-dim: #6a5040;
    --text-muted: #9a8878;
    --green: #2d6e2d;
    --radius: 2px;
    --font-serif: 'Cormorant Garamond', Georgia, serif;
    --font-mono: 'Inconsolata', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* LAYOUT */
  #app { display: flex; flex-direction: column; min-height: 100vh; }

  header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--font-serif);
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 0.15em;
    color: var(--gold);
    font-style: italic;
  }

  .logo span {
    font-size: 11px;
    font-family: var(--font-mono);
    font-style: normal;
    color: var(--text-dim);
    letter-spacing: 0.2em;
    display: block;
    margin-top: -4px;
  }

  .header-actions { display: flex; gap: 8px; align-items: center; }

  .sync-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--text-muted);
  }

  .sync-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
  }
  .sync-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .sync-dot.syncing { background: var(--gold); animation: pulse 1s infinite; }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  nav {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex;
    padding: 0 20px;
    gap: 0;
  }

  .nav-tab {
    padding: 10px 20px;
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    white-space: nowrap;
  }
  .nav-tab:hover { color: var(--cream-dim); }
  .nav-tab.active { color: var(--gold); border-bottom-color: var(--gold); }

  main { flex: 1; padding: 24px 20px; max-width: 1200px; margin: 0 auto; width: 100%; }

  /* VIEWS */
  .view { display: none; }
  .view.active { display: block; }

  /* CARDS & SURFACES */
  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .card-sm { padding: 14px 16px; }

  /* BUTTONS */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--cream-dim);
    cursor: pointer;
    border-radius: var(--radius);
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn:hover { background: var(--surface2); border-color: var(--border-light); color: var(--cream); }
  .btn-primary { background: var(--wine); border-color: var(--wine-light); color: var(--cream); }
  .btn-primary:hover { background: var(--wine-light); }
  .btn-gold { background: transparent; border-color: var(--gold); color: var(--gold); }
  .btn-gold:hover { background: var(--gold); color: var(--bg); }
  .btn-sm { padding: 5px 10px; font-size: 9px; }
  .btn-icon { padding: 8px; }

  /* INPUTS */
  input, select, textarea {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--cream);
    font-family: var(--font-mono);
    font-size: 12px;
    padding: 8px 12px;
    border-radius: var(--radius);
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--gold); }
  input::placeholder { color: var(--text-muted); }
  select option { background: var(--bg2); }

  label {
    font-size: 9px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    display: block;
    margin-bottom: 5px;
  }

  .field { margin-bottom: 14px; }

  /* GRID */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

  /* SECTION HEADER */
  .section-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  .section-title {
    font-family: var(--font-serif);
    font-size: 26px;
    font-weight: 300;
    color: var(--cream);
    font-style: italic;
  }
  .section-count {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.1em;
  }

  /* ===========================
     COLLECTION VIEW
  =========================== */
  #search-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
  }

  #search-input { flex: 1; }

  .filter-row {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filter-chip {
    padding: 4px 12px;
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    background: none;
    white-space: nowrap;
  }
  .filter-chip:hover, .filter-chip.active { border-color: var(--wine); color: var(--wine-light); background: rgba(139,26,26,0.1); }

  .bottle-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
  }

  .bottle-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .bottle-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--wine);
  }
  .bottle-card:hover { border-color: var(--border-light); background: var(--bg3); transform: translateY(-1px); }
  .bottle-card.red::before { background: var(--wine); }
  .bottle-card.white::before { background: var(--gold); }
  .bottle-card.rose::before { background: #c47080; }
  .bottle-card.sparkling::before { background: #8080c4; }
  .bottle-card.orange::before { background: #c47030; }

  .bottle-name {
    font-family: var(--font-serif);
    font-size: 16px;
    font-weight: 400;
    color: var(--cream);
    margin-bottom: 2px;
    line-height: 1.3;
  }
  .bottle-producer {
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 0.08em;
    margin-bottom: 10px;
  }
  .bottle-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  .tag {
    font-size: 9px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 2px 7px;
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text-muted);
  }
  .tag.vintage { border-color: var(--gold); color: var(--gold); }
  .tag.varietal { border-color: var(--border-light); color: var(--cream-dim); }

  .bottle-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
  }
  .bottle-location {
    font-size: 9px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
  }
  .bottle-rating {
    font-family: var(--font-serif);
    font-size: 14px;
    color: var(--gold);
  }
  .bottle-price {
    font-size: 10px;
    color: var(--green);
    letter-spacing: 0.05em;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-state .es-icon {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
    opacity: 0.3;
  }
  .empty-state h3 {
    font-family: var(--font-serif);
    font-size: 22px;
    font-weight: 300;
    font-style: italic;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .empty-state p { font-size: 11px; line-height: 1.7; }

  /* ===========================
     ADD BOTTLE VIEW
  =========================== */
  #scan-area {
    border: 1px dashed var(--border-light);
    border-radius: var(--radius);
    padding: 30px;
    text-align: center;
    margin-bottom: 20px;
    background: var(--bg3);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  #scan-area:hover { border-color: var(--gold); }
  #scan-area.processing { border-color: var(--gold); border-style: solid; pointer-events: none; }
  #scan-area.success { border-color: var(--green); border-style: solid; }

  #label-preview {
    width: 100%;
    max-width: 340px;
    max-height: 260px;
    object-fit: contain;
    display: none;
    border-radius: var(--radius);
    margin: 12px auto 0;
    border: 1px solid var(--border);
  }

  .scan-icon { font-size: 36px; color: var(--text-muted); margin-bottom: 10px; }
  .scan-hint { font-size: 10px; color: var(--text-muted); letter-spacing: 0.1em; }

  .ocr-progress {
    display: none;
    margin-top: 14px;
    font-size: 10px;
    color: var(--gold);
    letter-spacing: 0.12em;
  }
  .ocr-progress.visible { display: block; }

  .ocr-bar-track {
    height: 2px;
    background: var(--border);
    border-radius: 1px;
    margin-top: 8px;
    overflow: hidden;
  }
  .ocr-bar-fill {
    height: 100%;
    background: var(--gold);
    border-radius: 1px;
    width: 0%;
    transition: width 0.3s ease;
  }

  #file-input { display: none; }

  #paste-area:hover { border-color: var(--gold) !important; }
  #paste-area.success { border-color: var(--green) !important; border-style: solid !important; }

  .or-divider {
    display: flex;
    align-items: center;
    gap: 16px;
    margin: 20px 0;
    color: var(--text-muted);
    font-size: 10px;
    letter-spacing: 0.15em;
  }
  .or-divider::before, .or-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .form-section {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }
  .form-section-title {
    font-size: 9px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .search-results {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg3);
    max-height: 200px;
    overflow-y: auto;
    display: none;
  }
  .search-result-item {
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:hover { background: var(--surface); }
  .sri-name { font-size: 13px; color: var(--cream); margin-bottom: 2px; }
  .sri-meta { font-size: 10px; color: var(--text-dim); }

  /* ===========================
     CELLAR MAP VIEW
  =========================== */
  .rack-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .rack-selector {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .rack-tab {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    cursor: pointer;
    background: none;
    transition: all 0.15s;
  }
  .rack-tab:hover { border-color: var(--border-light); color: var(--cream-dim); }
  .rack-tab.active { border-color: var(--wine); color: var(--wine-light); background: rgba(139,26,26,0.1); }

  #rack-grid {
    display: inline-grid;
    gap: 4px;
    background: var(--bg3);
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: auto;
    max-width: 100%;
  }

  .rack-slot {
    width: 44px;
    height: 44px;
    border: 1px solid var(--border);
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg2);
  }
  .rack-slot:hover { border-color: var(--border-light); }
  .rack-slot.occupied { background: var(--surface); }
  .rack-slot.occupied.red { background: rgba(139,26,26,0.25); border-color: var(--wine); }
  .rack-slot.occupied.white { background: rgba(196,149,42,0.2); border-color: var(--gold); }
  .rack-slot.occupied.rose { background: rgba(196,112,128,0.2); border-color: #c47080; }
  .rack-slot.occupied.sparkling { background: rgba(128,128,196,0.2); border-color: #8080c4; }
  .rack-slot.occupied.orange { background: rgba(196,112,48,0.2); border-color: #c47030; }
  .rack-slot.selected { box-shadow: 0 0 0 2px var(--gold); }
  .rack-slot-label {
    font-size: 7px;
    color: var(--text-muted);
    position: absolute;
    bottom: 2px;
    right: 3px;
    letter-spacing: 0;
  }
  .rack-slot-tier {
    font-family: var(--font-mono);
    font-size: 7px;
    color: var(--text-muted);
    opacity: 0.55;
    position: absolute;
    bottom: 2px;
    left: 3px;
    letter-spacing: -0.5px;
    line-height: 1;
  }
  .rack-slot-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--wine);
    display: none;
  }
  .rack-slot.occupied .rack-slot-dot { display: block; }

  .rack-legend {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    flex-wrap: wrap;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 9px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
  }
  .legend-dot {
    width: 10px; height: 10px;
    border-radius: 2px;
  }

  .slot-tooltip {
    position: fixed;
    background: var(--bg2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 12px 14px;
    pointer-events: none;
    z-index: 200;
    max-width: 200px;
    display: none;
  }
  .slot-tooltip.visible { display: block; }
  .st-name { font-family: var(--font-serif); font-size: 15px; color: var(--cream); margin-bottom: 3px; }
  .st-meta { font-size: 10px; color: var(--text-dim); }

  /* ===========================
     BOTTLE DETAIL MODAL
  =========================== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 300;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  .modal-header {
    padding: 24px 24px 0;
    border-bottom: 1px solid var(--border);
    padding-bottom: 16px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .modal-wine-name {
    font-family: var(--font-serif);
    font-size: 28px;
    font-weight: 300;
    font-style: italic;
    color: var(--cream);
    line-height: 1.2;
  }
  .modal-producer { font-size: 11px; color: var(--text-dim); margin-top: 3px; letter-spacing: 0.05em; }

  .modal-body { padding: 0 24px 24px; }

  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }
  .detail-item { }
  .detail-label { font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
  .detail-value { font-size: 14px; color: var(--cream); font-family: var(--font-serif); }
  .detail-value.gold { color: var(--gold); }
  .detail-value.green { color: var(--green); }

  .notes-box {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    font-size: 12px;
    color: var(--cream-dim);
    line-height: 1.7;
    margin-bottom: 16px;
    font-family: var(--font-serif);
    font-style: italic;
  }

  .modal-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  /* ===========================
     STATS VIEW
  =========================== */
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    text-align: center;
  }
  .stat-number {
    font-family: var(--font-serif);
    font-size: 48px;
    font-weight: 300;
    color: var(--gold);
    line-height: 1;
    margin-bottom: 6px;
  }
  .stat-label { font-size: 9px; letter-spacing: 0.2em; color: var(--text-muted); text-transform: uppercase; }

  .bar-chart { margin-top: 16px; }
  .bar-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .bar-label { font-size: 10px; color: var(--text-dim); width: 70px; text-align: right; letter-spacing: 0.05em; }
  .bar-track { flex: 1; height: 6px; background: var(--bg3); border-radius: 3px; overflow: hidden; }
  .bar-fill { height: 100%; background: var(--wine); border-radius: 3px; transition: width 0.6s ease; }
  .bar-fill.gold { background: var(--gold); }
  .bar-fill.rose { background: #c47080; }
  .bar-fill.sparkling { background: #8080c4; }
  .bar-fill.orange { background: #c47030; }
  .bar-count { font-size: 10px; color: var(--text-muted); width: 24px; }

  /* ===========================
     RACK CONFIG MODAL
  =========================== */
  .rack-config-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .rack-config-item:last-child { border-bottom: none; }
  .rack-name-input { flex: 1; }

  /* TOASTS */
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 500;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    background: var(--surface2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 10px 16px;
    font-size: 11px;
    color: var(--cream);
    letter-spacing: 0.05em;
    animation: slideIn 0.2s ease;
    max-width: 280px;
  }
  .toast.success { border-color: var(--green); }
  .toast.error { border-color: var(--wine-light); }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* Pending sync badge */
  .pending-badge {
    background: var(--gold);
    color: var(--bg);
    border-radius: 10px;
    font-size: 8px;
    padding: 1px 5px;
    font-family: var(--font-mono);
    font-weight: 500;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  @media (max-width: 600px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .detail-grid { grid-template-columns: 1fr 1fr; }
    header { padding: 0 14px; }
    main { padding: 16px 14px; }
    .bottle-grid { grid-template-columns: 1fr 1fr; }
    nav { padding: 0 8px; overflow-x: auto; }
    .nav-tab { padding: 10px 12px; }
  }
</style>
</head>
<body>
<div id="app">

<header>
  <div>
    <div class="logo">cave <span>wine cellar &nbsp;¬∑&nbsp; <span id="app-version">v1.0.0</span></span></div>
  </div>
  <div class="header-actions">
    <button class="btn btn-sm btn-icon" onclick="openGithubSetup()" id="github-btn" title="GitHub Sync" style="font-size:15px;border-color:transparent;background:none;color:var(--text-muted)">‚áÖ</button>
    <div class="sync-indicator">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-label">OFFLINE</span>
      <span id="pending-count" class="pending-badge" style="display:none">0</span>
    </div>
  </div>
</header>

<nav>
  <button class="nav-tab active" data-view="collection">Collection</button>
  <button class="nav-tab" data-view="add">Add Bottle</button>
  <button class="nav-tab" data-view="cellar">Cellar Map</button>
  <button class="nav-tab" data-view="stats">Statistics</button>
</nav>

<main>

  <!-- COLLECTION -->
  <div class="view active" id="view-collection">
    <div class="section-header">
      <div class="section-title">My Collection</div>
      <span class="section-count" id="bottle-count">0 bottles</span>
    </div>
    <div id="search-bar">
      <input type="text" id="search-input" placeholder="Search by name, producer, varietal‚Ä¶">
      <button class="btn btn-sm" onclick="openSortMenu()">‚Üï Sort</button>
    </div>
    <div class="filter-row" id="filter-row">
      <button class="filter-chip active" data-filter="all">All</button>
      <button class="filter-chip" data-filter="red">Red</button>
      <button class="filter-chip" data-filter="white">White</button>
      <button class="filter-chip" data-filter="ros√©">Ros√©</button>
      <button class="filter-chip" data-filter="sparkling">Sparkling</button>
      <button class="filter-chip" data-filter="orange">Orange</button>
    </div>
    <div class="bottle-grid" id="bottle-grid"></div>
    <div id="empty-collection" class="empty-state" style="display:none">
      <span class="es-icon">üç∑</span>
      <h3 id="empty-title">Your cellar awaits</h3>
      <p id="empty-body">Add your first bottle to begin<br>tracking your collection.</p>
      <div id="empty-github-prompt" style="display:none;margin-top:16px">
        <button class="btn btn-primary" onclick="openGithubSetup()" style="font-size:11px;padding:8px 20px">
          Connect GitHub to restore your data
        </button>
        <p style="margin-top:10px;font-size:10px;color:var(--text-muted)">
          Already set up on another device?<br>Connect GitHub and pull your collection.
        </p>
      </div>
    </div>
  </div>

  <!-- ADD BOTTLE -->
  <div class="view" id="view-add">
    <div class="section-header">
      <div class="section-title">Add a Bottle</div>
    </div>

    <!-- Scanner -->
    <input type="file" id="file-input" accept="image/*" capture="environment" onchange="handleLabelPhoto(this)">

    <!-- Two scan options side by side -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px">

      <!-- Option 1: Photo scan -->
      <div id="scan-area" onclick="document.getElementById('file-input').click()" style="margin-bottom:0">
        <div class="scan-icon" id="scan-icon-el">üì∑</div>
        <div class="scan-hint" id="scan-hint-el">PHOTO SCAN</div>
        <img id="label-preview" alt="Label preview">
        <div class="ocr-progress" id="ocr-progress">
          <span id="ocr-status">Reading label‚Ä¶</span>
          <div class="ocr-bar-track"><div class="ocr-bar-fill" id="ocr-bar"></div></div>
        </div>
      </div>

      <!-- Option 2: Live Text paste -->
      <div id="paste-area" onclick="openPastePanel()" style="
        border:1px dashed var(--border-light);border-radius:var(--radius);
        padding:30px 16px;text-align:center;background:var(--bg3);
        cursor:pointer;transition:all 0.2s;
      ">
        <div style="font-size:36px;color:var(--text-muted);margin-bottom:10px">‚úé</div>
        <div style="font-size:10px;color:var(--text-muted);letter-spacing:0.1em">PASTE LABEL TEXT</div>
        <div style="font-size:9px;color:var(--text-muted);margin-top:6px;letter-spacing:0.05em;line-height:1.5">Use iPhone Live Text<br>to copy, paste here</div>
      </div>
    </div>

    <!-- Paste panel (hidden by default) -->
    <div id="paste-panel" style="display:none;margin-bottom:20px">
      <div class="form-section" style="margin-bottom:0">
        <div class="form-section-title" style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
          <span>Paste Label Text</span>
          <button onclick="closePastePanel()" style="background:none;border:none;color:var(--text-muted);font-size:16px;cursor:pointer;padding:0">‚úï</button>
        </div>
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:10px;line-height:1.7">
          On iPhone: open Camera ‚Üí point at label ‚Üí tap Live Text icon (bottom right) ‚Üí Select All ‚Üí Copy. Then paste below.
        </div>
        <textarea id="paste-input" rows="5" placeholder="Paste label text here‚Ä¶" style="margin-bottom:10px;font-size:13px;line-height:1.6"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-sm" onclick="closePastePanel()">Cancel</button>
          <button class="btn btn-sm btn-primary" onclick="processPastedText()">Parse Label</button>
        </div>
      </div>
    </div>

    <div class="or-divider">or search manually</div>

    <div class="form-section">
      <div class="form-section-title">Wine Details</div>
      <div class="field">
        <label>Search by name or producer</label>
        <input type="text" id="wine-search" placeholder="e.g. Ch√¢teauneuf-du-Pape, Penfolds‚Ä¶" oninput="handleWineSearch(this.value)">
        <div class="search-results" id="search-results"></div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Wine Name / Cuv√©e</label>
          <input type="text" id="f-name" placeholder="e.g. Ch√¢teau Margaux">
        </div>
        <div class="field">
          <label>Producer</label>
          <input type="text" id="f-producer" placeholder="e.g. Ch√¢teau Margaux">
        </div>
      </div>
      <div class="grid-3">
        <div class="field">
          <label>Vintage</label>
          <input type="number" id="f-vintage" placeholder="2019" min="1800" max="2030">
        </div>
        <div class="field">
          <label>Varietal</label>
          <input type="text" id="f-varietal" placeholder="e.g. Cabernet Sauvignon">
        </div>
        <div class="field">
          <label>Type</label>
          <select id="f-type">
            <option value="red">Red</option>
            <option value="white">White</option>
            <option value="ros√©">Ros√©</option>
            <option value="sparkling">Sparkling</option>
            <option value="orange">Orange</option>
            <option value="dessert">Dessert</option>
            <option value="fortified">Fortified</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Region / Appellation</label>
          <input type="text" id="f-region" placeholder="e.g. Bordeaux, Napa Valley">
        </div>
        <div class="field">
          <label>Country</label>
          <input type="text" id="f-country" placeholder="e.g. France">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Acquisition & Pricing</div>
      <div class="grid-3">
        <div class="field">
          <label>Purchase Price ($)</label>
          <input type="number" id="f-purchase-price" placeholder="0.00" step="0.01">
        </div>
        <div class="field">
          <label>Market Value ($)</label>
          <input type="number" id="f-market-value" placeholder="0.00" step="0.01">
        </div>
        <div class="field">
          <label>Quantity</label>
          <input type="number" id="f-quantity" placeholder="1" min="1" value="1">
        </div>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="field">
          <label>Price Tier</label>
          <select id="f-price-tier">
            <option value="">‚Äî select ‚Äî</option>
            <option value="$">$ ¬∑ Everyday</option>
            <option value="$$">$$ ¬∑ Mid-range</option>
            <option value="$$$">$$$ ¬∑ Premium</option>
            <option value="$$$$">$$$$ ¬∑ Prestige</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Date Acquired</label>
          <input type="date" id="f-date">
        </div>
        <div class="field">
          <label>Drink By / Peak</label>
          <input type="text" id="f-drink-by" placeholder="e.g. 2025‚Äì2035">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Cellar Location</div>
      <div class="grid-2">
        <div class="field">
          <label>Rack</label>
          <select id="f-rack"></select>
        </div>
        <div class="field">
          <label>Slot (Row √ó Col)</label>
          <div style="display:flex;gap:6px">
            <input type="number" id="f-row" placeholder="Row" min="1" style="width:50%">
            <input type="number" id="f-col" placeholder="Col" min="1" style="width:50%">
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Ratings & Notes</div>
      <div class="grid-2">
        <div class="field">
          <label>Score (0‚Äì100)</label>
          <input type="number" id="f-score" placeholder="e.g. 92" min="0" max="100">
        </div>
        <div class="field">
          <label>Critic / Source</label>
          <input type="text" id="f-critic" placeholder="e.g. Wine Spectator">
        </div>
      </div>
      <div class="field">
        <label>Tasting Notes</label>
        <textarea id="f-notes" rows="3" placeholder="Aromas, palate, finish‚Ä¶"></textarea>
      </div>
      <div class="field">
        <label>Personal Notes</label>
        <textarea id="f-personal" rows="2" placeholder="Where you bought it, occasion‚Ä¶"></textarea>
      </div>
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" onclick="clearForm()">Clear</button>
      <button class="btn btn-primary" onclick="addBottle()">Add to Cellar</button>
    </div>
  </div>

  <!-- CELLAR MAP -->
  <div class="view" id="view-cellar">
    <div class="section-header">
      <div class="section-title">Cellar Map</div>
      <button class="btn btn-sm btn-gold" onclick="openRackConfig()">‚öô Manage Racks</button>
    </div>

    <div class="rack-controls">
      <div class="rack-selector" id="rack-selector"></div>
    </div>

    <div id="rack-grid-wrap">
      <div id="rack-col-labels" style="display:flex;gap:4px;margin-bottom:4px;padding-left:36px"></div>
      <div style="display:flex;gap:4px">
        <div id="rack-row-labels" style="display:flex;flex-direction:column;gap:4px;justify-content:flex-start;"></div>
        <div id="rack-grid"></div>
      </div>
    </div>

    <div class="rack-legend">
      <div class="legend-item"><div class="legend-dot" style="background:rgba(139,26,26,0.4);border:1px solid #8b1a1a"></div> Red</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(196,149,42,0.3);border:1px solid #c4952a"></div> White</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(196,112,128,0.3);border:1px solid #c47080"></div> Ros√©</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(128,128,196,0.3);border:1px solid #8080c4"></div> Sparkling</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(196,112,48,0.3);border:1px solid #c47030"></div> Orange</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--bg2);border:1px solid var(--border)"></div> Empty</div>
    </div>
  </div>

  <!-- STATS -->
  <div class="view" id="view-stats">
    <!-- Hidden CSV upload input -->
    <input type="file" id="csv-import-input" accept=".csv" style="display:none" onchange="handleCsvImport(this)">

    <div class="section-header">
      <div class="section-title">Statistics</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm" onclick="exportCsv()">‚Üì Export CSV</button>
        <button class="btn btn-sm btn-gold" onclick="document.getElementById('csv-import-input').click()">‚Üë Import CSV</button>
      </div>
    </div>

    <div class="grid-3" style="margin-bottom:20px">
      <div class="stat-card">
        <div class="stat-number" id="stat-total">0</div>
        <div class="stat-label">Total Bottles</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-value" style="font-size:32px">$0</div>
        <div class="stat-label">Est. Value</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-avg-score">‚Äî</div>
        <div class="stat-label">Avg Score</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="form-section-title" style="margin-bottom:14px">By Type</div>
        <div class="bar-chart" id="chart-type"></div>
      </div>
      <div class="card">
        <div class="form-section-title" style="margin-bottom:14px">By Vintage Decade</div>
        <div class="bar-chart" id="chart-decade"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="form-section-title" style="margin-bottom:14px">By Region</div>
      <div class="bar-chart" id="chart-region"></div>
    </div>
  </div>

</main>
</div>

<!-- BOTTLE DETAIL MODAL -->
<div class="modal-overlay" id="bottle-modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-wine-name" id="m-name">‚Äî</div>
        <div class="modal-producer" id="m-producer">‚Äî</div>
      </div>
      <button class="btn btn-sm btn-icon" onclick="closeModal('bottle-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid">
        <div class="detail-item"><div class="detail-label">Vintage</div><div class="detail-value" id="m-vintage">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Type</div><div class="detail-value" id="m-type">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Varietal</div><div class="detail-value" id="m-varietal">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Region</div><div class="detail-value" id="m-region">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Score</div><div class="detail-value gold" id="m-score">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Market Value</div><div class="detail-value green" id="m-value">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Location</div><div class="detail-value" id="m-location">‚Äî</div></div>
        <div class="detail-item"><div class="detail-label">Drink Window</div><div class="detail-value" id="m-drink">‚Äî</div></div>
      </div>
      <div id="m-notes-wrap" style="display:none">
        <label style="margin-bottom:6px">Tasting Notes</label>
        <div class="notes-box" id="m-notes"></div>
      </div>
      <div id="m-personal-wrap" style="display:none">
        <label style="margin-bottom:6px">Personal Notes</label>
        <div class="notes-box" id="m-personal" style="font-style:normal;font-family:var(--font-mono);font-size:11px"></div>
      </div>
      <div id="m-sync-status" style="font-size:10px;color:var(--text-muted);margin-bottom:12px;"></div>
      <div class="modal-actions">
        <button class="btn btn-sm btn-gold" onclick="syncBottle(currentBottleId)">‚Üª Fetch Data</button>
        <button class="btn btn-sm" onclick="editBottleModal(currentBottleId)">‚úè Edit</button>
        <button class="btn btn-sm" style="margin-left:auto;border-color:var(--wine);color:var(--wine-light)" onclick="removeBottle(currentBottleId)">Remove</button>
      </div>
    </div>
  </div>
</div>

<!-- RACK CONFIG MODAL -->
<div class="modal-overlay" id="rack-modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-wine-name">Manage Racks</div>
        <div class="modal-producer">Configure your cellar shelving</div>
      </div>
      <button class="btn btn-sm btn-icon" onclick="closeModal('rack-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="rack-config-list"></div>
      <div style="display:flex;gap:10px;margin-top:16px;align-items:flex-end">
        <div class="field" style="flex:2;margin:0">
          <label>Rack Name</label>
          <input type="text" id="new-rack-name" placeholder="e.g. Basement Rack A">
        </div>
        <div class="field" style="flex:1;margin:0">
          <label>Rows</label>
          <input type="number" id="new-rack-rows" value="6" min="1" max="30">
        </div>
        <div class="field" style="flex:1;margin:0">
          <label>Cols</label>
          <input type="number" id="new-rack-cols" value="12" min="1" max="50">
        </div>
        <button class="btn btn-primary btn-sm" onclick="addRack()" style="height:34px;align-self:flex-end">+ Add</button>
      </div>
    </div>
  </div>
</div>

<!-- Slot tooltip -->
<div class="slot-tooltip" id="slot-tooltip">
  <div class="st-name" id="tt-name"></div>
  <div class="st-meta" id="tt-meta"></div>
</div>

<!-- GitHub Setup Modal -->
<div class="modal-overlay" id="github-modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-wine-name">GitHub Sync</div>
        <div class="modal-producer">Store your cellar data in your repository</div>
      </div>
      <button class="btn btn-sm btn-icon" onclick="closeModal('github-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="github-setup-view">
        <div style="font-size:11px;color:var(--text-dim);line-height:1.8;margin-bottom:16px">
          Your bottle data will be saved as <code style="color:var(--gold);font-size:11px">data/cellar.json</code> in your GitHub repo. You need a Personal Access Token with <code style="color:var(--gold);font-size:11px">repo</code> scope ‚Äî it's stored only on this device.
        </div>
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:14px;letter-spacing:0.08em">
          To create a token: github.com ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic) ‚Üí Generate new token ‚Üí check <strong style="color:var(--cream-dim)">repo</strong> ‚Üí Generate
        </div>
        <div class="field">
          <label>GitHub Username</label>
          <input type="text" id="gh-username" placeholder="e.g. tzoom08">
        </div>
        <div class="field">
          <label>Repository Name</label>
          <input type="text" id="gh-repo" placeholder="e.g. cave">
        </div>
        <div class="field">
          <label>Personal Access Token</label>
          <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px">
          <button class="btn btn-sm" onclick="closeModal('github-modal')">Cancel</button>
          <button class="btn btn-sm btn-gold" onclick="saveGithubConfig()">Save & Sync</button>
        </div>
      </div>
      <div id="github-status-view" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
          <div class="sync-dot online"></div>
          <div>
            <div style="font-size:13px;color:var(--cream)" id="gh-status-repo">‚Äî</div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:2px" id="gh-status-detail">Connected</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sm btn-gold" onclick="githubPush()">‚Üë Push to GitHub</button>
          <button class="btn btn-sm" onclick="githubPull()">‚Üì Pull from GitHub</button>
          <button class="btn btn-sm" style="margin-left:auto;border-color:var(--wine);color:var(--wine-light)" onclick="disconnectGithub()">Disconnect</button>
        </div>
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px">
          <button class="btn btn-sm" onclick="checkForAppUpdate(this)" style="width:100%">‚ü≥ Check for App Updates</button>
        </div>
        <div id="update-check-status" style="display:none;margin-top:8px;font-size:10px;color:var(--text-muted);letter-spacing:0.06em"></div>
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted);line-height:1.7">
          Auto-sync is <strong style="color:var(--cream-dim)">on</strong> ‚Äî every add, edit, or delete pushes to GitHub automatically when online. Pull manually if you've edited <code style="color:var(--gold)">cellar.json</code> directly.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
<script>
// ===========================
// DATABASE (IndexedDB via Dexie)
// ===========================
const db = new Dexie('CaveWineCellar');
db.version(2).stores({
  bottles: '++id, name, producer, vintage, type, varietal, region, rack, row, col, synced, addedAt',
  racks: '++id, name, rows, cols',
  syncQueue: '++id, bottleId, action, timestamp'
});
db.version(3).stores({
  bottles: '++id, name, producer, vintage, type, varietal, region, rack, row, col, synced, addedAt',
  racks: '++id, name, rows, cols',
  syncQueue: '++id, bottleId, action, timestamp',
  photoQueue: '++id, addedAt, processed'
});
db.version(4).stores({
  bottles: '++id, name, producer, vintage, type, varietal, region, rack, row, col, synced, addedAt',
  racks: '++id, name, rows, cols',
  syncQueue: '++id, bottleId, action, timestamp',
  photoQueue: '++id, addedAt, processed',
  settings: 'key'
});

// ===========================
// VERSION
// ===========================
const APP_VERSION = '1.2.4';

// ===========================
// STATE
// ===========================
let bottles = [];
let racks = [];
let currentFilter = 'all';
let currentSort = 'addedAt';
let currentRackId = null;
let currentBottleId = null;
let ocrWorker = null;
let searchDebounce = null;
let ghConfig = null; // { username, repo, token } ‚Äî loaded from IndexedDB

// ===========================
// INIT
// ===========================
async function init() {
  // Show version
  document.getElementById('app-version').textContent = 'v' + APP_VERSION;

  // Load GitHub config from IndexedDB settings store
  await loadGithubConfig();

  await loadRacks();

  // If GitHub configured and online, pull latest data first
  if (ghConfig && navigator.onLine) {
    await githubPull({ silent: true });
  } else {
    await loadBottles();
  }

  renderCollection();
  renderStats();
  setupNav();
  setupFilters();
  updateSyncStatus();
  window.addEventListener('online', () => { updateSyncStatus(); processSyncQueue(); processPhotoQueue(); });
  window.addEventListener('offline', updateSyncStatus);

  // Set today's date
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];

  // Check for unprocessed queued photos
  const queuedPhotos = await db.photoQueue.where('processed').equals(0).count();
  if (queuedPhotos > 0) {
    updatePhotoQueueBadge();
    if (navigator.onLine) {
      // Small delay to let UI render first
      setTimeout(() => processPhotoQueue(), 1500);
    } else {
      toast(`${queuedPhotos} photo${queuedPhotos > 1 ? 's' : ''} queued ‚Äî will process when online`);
    }
  }
}

// ===========================
// NAV
// ===========================
function setupNav() {
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('view-' + tab.dataset.view).classList.add('active');
      if (tab.dataset.view === 'cellar') renderCellar();
      if (tab.dataset.view === 'stats') renderStats();
      if (tab.dataset.view === 'add') populateRackSelect();
    });
  });
}

// ===========================
// RACKS
// ===========================
async function loadRacks() {
  racks = await db.racks.toArray();
  if (racks.length === 0) {
    // Default rack
    const id = await db.racks.add({ name: 'Main Rack', rows: 6, cols: 12 });
    racks = await db.racks.toArray();
  }
  currentRackId = racks[0].id;
}

async function addRack() {
  const name = document.getElementById('new-rack-name').value.trim() || 'New Rack';
  const rows = parseInt(document.getElementById('new-rack-rows').value) || 6;
  const cols = parseInt(document.getElementById('new-rack-cols').value) || 12;
  await db.racks.add({ name, rows, cols });
  racks = await db.racks.toArray();
  renderRackConfig();
  populateRackSelect();
  renderCellarTabs();
  toast('Rack added');
}

async function removeRack(id) {
  if (racks.length <= 1) { toast('Cannot remove last rack', 'error'); return; }
  await db.racks.delete(id);
  racks = await db.racks.toArray();
  if (currentRackId === id) currentRackId = racks[0].id;
  renderRackConfig();
  renderCellarTabs();
  renderCellar();
}

function openRackConfig() {
  renderRackConfig();
  document.getElementById('rack-modal').classList.add('open');
}

function renderRackConfig() {
  const list = document.getElementById('rack-config-list');
  list.innerHTML = racks.map(r => `
    <div class="rack-config-item" id="rack-cfg-${r.id}">
      <div style="display:flex;gap:6px;align-items:center;flex:1" id="rack-view-${r.id}">
        <span style="flex:2;font-size:13px;color:var(--text)">${r.name}</span>
        <span style="font-size:10px;color:var(--text-muted);white-space:nowrap">${r.rows}R √ó ${r.cols}C</span>
        <button class="btn btn-sm" onclick="startEditRack(${r.id})" style="white-space:nowrap">Edit</button>
        <button class="btn btn-sm" style="border-color:var(--wine);color:var(--wine-light);white-space:nowrap" onclick="removeRack(${r.id})">Remove</button>
      </div>
      <div style="display:none;gap:6px;align-items:center;flex:1;flex-wrap:wrap" id="rack-edit-${r.id}">
        <input type="text" value="${r.name}" id="rack-edit-name-${r.id}" placeholder="Rack name"
          style="flex:2;min-width:100px;font-size:12px;padding:5px 8px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:2px;outline:none">
        <input type="number" value="${r.rows}" id="rack-edit-rows-${r.id}" min="1" max="30"
          style="width:52px;font-size:12px;padding:5px 6px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:2px;outline:none" title="Rows">
        <input type="number" value="${r.cols}" id="rack-edit-cols-${r.id}" min="1" max="50"
          style="width:52px;font-size:12px;padding:5px 6px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:2px;outline:none" title="Cols">
        <button class="btn btn-sm btn-primary" onclick="saveEditRack(${r.id})">Save</button>
        <button class="btn btn-sm" onclick="cancelEditRack(${r.id})">Cancel</button>
      </div>
    </div>
  `).join('') || '<div style="color:var(--text-muted);font-size:11px;padding:10px 0">No racks configured</div>';
}

function startEditRack(id) {
  document.getElementById('rack-view-' + id).style.display = 'none';
  document.getElementById('rack-edit-' + id).style.display = 'flex';
  document.getElementById('rack-edit-name-' + id).focus();
}

function cancelEditRack(id) {
  document.getElementById('rack-edit-' + id).style.display = 'none';
  document.getElementById('rack-view-' + id).style.display = 'flex';
}

async function saveEditRack(id) {
  const name = document.getElementById('rack-edit-name-' + id).value.trim() || 'Rack';
  const rows = parseInt(document.getElementById('rack-edit-rows-' + id).value) || 6;
  const cols = parseInt(document.getElementById('rack-edit-cols-' + id).value) || 12;
  await db.racks.update(id, { name, rows, cols });
  racks = await db.racks.toArray();
  if (!currentRackId) currentRackId = racks[0]?.id || null;
  renderRackConfig();
  renderCellarTabs();
  renderCellar();
  githubPush({ silent: true });
  toast('Rack updated ‚úì', 'success');
}

function populateRackSelect() {
  const sel = document.getElementById('f-rack');
  sel.innerHTML = racks.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
}

// ===========================
// BOTTLES - LOAD
// ===========================
async function loadBottles() {
  bottles = await db.bottles.orderBy('addedAt').reverse().toArray();
}

// ===========================
// COLLECTION RENDER
// ===========================
function renderCollection() {
  const query = document.getElementById('search-input').value.toLowerCase();
  let filtered = bottles.filter(b => {
    const matchFilter = currentFilter === 'all' || b.type === currentFilter || b.type === currentFilter.replace('√©', 'e');
    const matchSearch = !query ||
      (b.name || '').toLowerCase().includes(query) ||
      (b.producer || '').toLowerCase().includes(query) ||
      (b.varietal || '').toLowerCase().includes(query) ||
      (b.region || '').toLowerCase().includes(query);
    return matchFilter && matchSearch;
  });

  // Sort
  filtered.sort((a, b) => {
    if (currentSort === 'vintage') return (b.vintage || 0) - (a.vintage || 0);
    if (currentSort === 'name') return (a.name || '').localeCompare(b.name || '');
    if (currentSort === 'score') return (b.score || 0) - (a.score || 0);
    return new Date(b.addedAt) - new Date(a.addedAt);
  });

  const grid = document.getElementById('bottle-grid');
  const empty = document.getElementById('empty-collection');
  const count = document.getElementById('bottle-count');
  count.textContent = `${bottles.length} bottle${bottles.length !== 1 ? 's' : ''}`;

  if (filtered.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    // If no bottles AND no GitHub config, nudge them to connect
    const prompt = document.getElementById('empty-github-prompt');
    if (prompt) {
      const hasConfig = !!ghConfig;
      const hasBottles = bottles.length > 0;
      prompt.style.display = (!hasConfig && !hasBottles) ? 'block' : 'none';
    }
    return;
  }
  document.getElementById('empty-github-prompt').style.display = 'none';
  empty.style.display = 'none';

  grid.innerHTML = filtered.map(b => {
    const price = b.purchasePrice || b.marketValue;
    const priceLabel = price
      ? `<div style="
          font-family:var(--font-mono);font-size:11px;font-weight:600;
          color:var(--wine);letter-spacing:0.04em;margin-bottom:8px;
        ">$${price % 1 === 0 ? price : price.toFixed(2)}</div>`
      : '';
    return `
    <div class="bottle-card ${b.type || ''}" onclick="openBottle(${b.id})">
      ${priceLabel}
      <div class="bottle-name">${b.name || 'Unnamed Wine'}</div>
      <div class="bottle-producer">${b.producer || '‚Äî'}</div>
      <div class="bottle-meta">
        ${b.vintage ? `<span class="tag vintage">${b.vintage}</span>` : ''}
        ${b.varietal ? `<span class="tag varietal">${b.varietal}</span>` : ''}
      </div>
      <div class="bottle-footer">
        <span class="bottle-location">${getLocationStr(b)}</span>
        <span>${b.score ? `<span class="bottle-rating">${b.score}</span>` : ''}</span>
      </div>
    </div>`;
  }).join('');
}

function getLocationStr(b) {
  if (!b.rack && !b.row && !b.col) return 'No location';
  const rack = racks.find(r => r.id == b.rack);
  const rName = rack ? rack.name : 'Rack';
  if (b.row && b.col) return `${rName} ¬∑ R${b.row}C${b.col}`;
  return rName;
}

function setupFilters() {
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      currentFilter = chip.dataset.filter;
      renderCollection();
    });
  });
  document.getElementById('search-input').addEventListener('input', renderCollection);
}

function openSortMenu() {
  const opts = ['addedAt', 'vintage', 'name', 'score'];
  const labels = { addedAt: 'Date Added', vintage: 'Vintage', name: 'Name', score: 'Score' };
  const cur = opts[(opts.indexOf(currentSort) + 1) % opts.length];
  currentSort = cur;
  toast('Sorted by: ' + labels[cur]);
  renderCollection();
}

// ===========================
// BOTTLE DETAIL
// ===========================
async function openBottle(id) {
  const b = await db.bottles.get(id);
  if (!b) return;
  currentBottleId = id;
  document.getElementById('m-name').textContent = b.name || '‚Äî';
  document.getElementById('m-producer').textContent = b.producer || '‚Äî';
  document.getElementById('m-vintage').textContent = b.vintage || '‚Äî';
  document.getElementById('m-type').textContent = capitalize(b.type || '‚Äî');
  document.getElementById('m-varietal').textContent = b.varietal || '‚Äî';
  document.getElementById('m-region').textContent = [b.region, b.country].filter(Boolean).join(', ') || '‚Äî';
  document.getElementById('m-score').textContent = b.score ? `${b.score}${b.critic ? ' ¬∑ ' + b.critic : ''}` : '‚Äî';
  document.getElementById('m-value').textContent = b.marketValue ? `$${b.marketValue}` : '‚Äî';
  document.getElementById('m-location').textContent = getLocationStr(b);
  document.getElementById('m-drink').textContent = b.drinkBy || '‚Äî';

  const notesWrap = document.getElementById('m-notes-wrap');
  if (b.notes) { notesWrap.style.display = 'block'; document.getElementById('m-notes').textContent = b.notes; }
  else notesWrap.style.display = 'none';

  const personalWrap = document.getElementById('m-personal-wrap');
  if (b.personal) { personalWrap.style.display = 'block'; document.getElementById('m-personal').textContent = b.personal; }
  else personalWrap.style.display = 'none';

  const syncEl = document.getElementById('m-sync-status');
  if (b.synced) syncEl.textContent = '‚úì Data synced from open sources';
  else if (!navigator.onLine) syncEl.textContent = '‚ö† Offline ‚Äî enrichment pending';
  else syncEl.textContent = '';

  document.getElementById('bottle-modal').classList.add('open');
}

async function removeBottle(id) {
  if (!confirm('Remove this bottle from your cellar?')) return;
  await db.bottles.delete(id);
  closeModal('bottle-modal');
  await loadBottles();
  renderCollection();
  renderStats();
  toast('Bottle removed');
  githubPush({ silent: true });
}

function editBottleModal(id) {
  closeModal('bottle-modal');
  const b = bottles.find(x => x.id === id);
  if (!b) return;
  // Switch to add tab and populate
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelector('[data-view="add"]').classList.add('active');
  document.getElementById('view-add').classList.add('active');
  populateForm(b);
  // Store edit id
  document.getElementById('f-name').dataset.editId = id;
}

function populateForm(b) {
  document.getElementById('f-name').value = b.name || '';
  document.getElementById('f-producer').value = b.producer || '';
  document.getElementById('f-vintage').value = b.vintage || '';
  document.getElementById('f-varietal').value = b.varietal || '';
  document.getElementById('f-type').value = b.type || 'red';
  document.getElementById('f-region').value = b.region || '';
  document.getElementById('f-country').value = b.country || '';
  document.getElementById('f-purchase-price').value = b.purchasePrice || '';
  document.getElementById('f-market-value').value = b.marketValue || '';
  document.getElementById('f-quantity').value = b.quantity || 1;
  document.getElementById('f-drink-by').value = b.drinkBy || '';
  document.getElementById('f-price-tier').value = b.priceTier || '';
  document.getElementById('f-score').value = b.score || '';
  document.getElementById('f-critic').value = b.critic || '';
  document.getElementById('f-notes').value = b.notes || '';
  document.getElementById('f-personal').value = b.personal || '';
  populateRackSelect();
  if (b.rack) document.getElementById('f-rack').value = b.rack;
  document.getElementById('f-row').value = b.row || '';
  document.getElementById('f-col').value = b.col || '';
}

// ===========================
// ADD BOTTLE
// ===========================
async function addBottle() {
  const nameEl = document.getElementById('f-name');
  const editId = nameEl.dataset.editId ? parseInt(nameEl.dataset.editId) : null;

  const bottle = {
    name: document.getElementById('f-name').value.trim(),
    producer: document.getElementById('f-producer').value.trim(),
    vintage: parseInt(document.getElementById('f-vintage').value) || null,
    varietal: document.getElementById('f-varietal').value.trim(),
    type: document.getElementById('f-type').value,
    region: document.getElementById('f-region').value.trim(),
    country: document.getElementById('f-country').value.trim(),
    purchasePrice: parseFloat(document.getElementById('f-purchase-price').value) || null,
    marketValue: parseFloat(document.getElementById('f-market-value').value) || null,
    quantity: parseInt(document.getElementById('f-quantity').value) || 1,
    drinkBy: document.getElementById('f-drink-by').value.trim(),
    priceTier: document.getElementById('f-price-tier').value || null,
    rack: parseInt(document.getElementById('f-rack').value) || null,
    row: parseInt(document.getElementById('f-row').value) || null,
    col: parseInt(document.getElementById('f-col').value) || null,
    score: parseInt(document.getElementById('f-score').value) || null,
    critic: document.getElementById('f-critic').value.trim(),
    notes: document.getElementById('f-notes').value.trim(),
    personal: document.getElementById('f-personal').value.trim(),
    synced: false,
    addedAt: new Date().toISOString()
  };

  if (!bottle.name) { toast('Please enter a wine name', 'error'); return; }

  if (editId) {
    await db.bottles.update(editId, bottle);
    delete nameEl.dataset.editId;
    toast('Bottle updated');
  } else {
    const id = await db.bottles.add(bottle);
    // Queue sync
    await db.syncQueue.add({ bottleId: id, action: 'enrich', timestamp: new Date().toISOString() });
    toast('Bottle added to cellar');
    // Try immediate sync if online
    if (navigator.onLine) syncBottle(id);
  }

  clearForm();
  await loadBottles();
  renderCollection();
  renderStats();
  renderCellar();
  githubPush({ silent: true });
}

function clearForm() {
  ['f-name','f-producer','f-vintage','f-varietal','f-region','f-country',
   'f-purchase-price','f-market-value','f-drink-by','f-score','f-critic','f-notes','f-personal',
   'f-row','f-col'].forEach(id => { document.getElementById(id).value = ''; });
  document.getElementById('f-quantity').value = 1;
  document.getElementById('f-price-tier').value = '';
  document.getElementById('f-type').value = 'red';
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
  delete document.getElementById('f-name').dataset.editId;
}

// ===========================
// WINE SEARCH (Open Wine API / Open Food Facts)
// ===========================
async function handleWineSearch(query) {
  clearTimeout(searchDebounce);
  const results = document.getElementById('search-results');
  if (query.length < 3) { results.style.display = 'none'; return; }

  searchDebounce = setTimeout(async () => {
    if (!navigator.onLine) {
      results.style.display = 'none';
      toast('Offline ‚Äî search unavailable');
      return;
    }
    results.style.display = 'block';
    results.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">Searching‚Ä¶</div>';

    try {
      // Open Food Facts wine search
      const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&categories_tags=wines&json=1&page_size=8&fields=product_name,brands,ingredients_text,nutrition_grades,quantity`;
      const resp = await fetch(url);
      const data = await resp.json();
      const products = (data.products || []).filter(p => p.product_name);

      if (products.length === 0) {
        results.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">No results found</div>';
        return;
      }

      results.innerHTML = products.slice(0, 8).map(p => `
        <div class="search-result-item" onclick="selectWineResult(${JSON.stringify({
          name: p.product_name,
          producer: p.brands || '',
          notes: p.ingredients_text || ''
        }).replace(/"/g,'&quot;')})">
          <div class="sri-name">${p.product_name}</div>
          <div class="sri-meta">${p.brands || 'Unknown producer'}${p.quantity ? ' ¬∑ ' + p.quantity : ''}</div>
        </div>
      `).join('');
    } catch(e) {
      results.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">Search unavailable</div>';
    }
  }, 400);
}

function selectWineResult(data) {
  document.getElementById('f-name').value = data.name || '';
  document.getElementById('f-producer').value = data.producer || '';
  if (data.notes) document.getElementById('f-notes').value = data.notes;
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('wine-search').value = '';
}

// ===========================
// SYNC / ENRICH
// ===========================
async function syncBottle(id) {
  if (!navigator.onLine) { toast('Offline ‚Äî will sync when connected'); return; }
  const b = await db.bottles.get(id);
  if (!b) return;

  toast('Fetching wine data‚Ä¶');
  let enriched = {};

  // Try Open Food Facts barcode or name search
  try {
    const query = [b.name, b.producer, b.vintage].filter(Boolean).join(' ');
    const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&categories_tags=wines&json=1&page_size=1&fields=product_name,brands,ingredients_text,origins,countries`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.products && data.products[0]) {
      const p = data.products[0];
      enriched.country = enriched.country || p.countries || b.country;
      enriched.region = enriched.region || p.origins || b.region;
      if (p.ingredients_text && !b.notes) enriched.notes = p.ingredients_text;
    }
  } catch(e) {}

  enriched.synced = true;
  await db.bottles.update(id, enriched);
  await db.syncQueue.where('bottleId').equals(id).delete();
  await loadBottles();
  renderCollection();
  toast('Wine data updated ‚úì', 'success');
}

async function processSyncQueue() {
  const queue = await db.syncQueue.toArray();
  for (const item of queue) {
    await syncBottle(item.bottleId);
  }
  updatePendingCount();
}

async function updatePendingCount() {
  const count = await db.syncQueue.count();
  const badge = document.getElementById('pending-count');
  if (count > 0) { badge.textContent = count; badge.style.display = 'inline'; }
  else badge.style.display = 'none';
}

// ===========================
// BARCODE SCANNER
// ===========================
// ===========================
// LABEL PHOTO + OCR
// ===========================

async function handleLabelPhoto(input) {
  const file = input.files[0];
  if (!file) return;

  // Show preview immediately
  const preview = document.getElementById('label-preview');
  const reader = new FileReader();
  reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
  reader.readAsDataURL(file);

  // Update UI state
  const area = document.getElementById('scan-area');
  const iconEl = document.getElementById('scan-icon-el');
  const hintEl = document.getElementById('scan-hint-el');
  const progressEl = document.getElementById('ocr-progress');
  const statusEl = document.getElementById('ocr-status');
  const barEl = document.getElementById('ocr-bar');

  area.classList.add('processing');
  iconEl.style.display = 'none';
  progressEl.classList.add('visible');
  statusEl.textContent = 'Reading label‚Ä¶';
  barEl.style.width = '20%';

  try {
    // Resize image regardless of online status
    const base64 = await resizeImageToBase64(file, 1200);

    if (!navigator.onLine) {
      // OFFLINE: save photo to queue for later processing
      await db.photoQueue.add({
        base64,
        addedAt: new Date().toISOString(),
        processed: false,
        note: ''
      });
      const queueCount = await db.photoQueue.where('processed').equals(0).count();

      area.classList.remove('processing');
      progressEl.classList.remove('visible');
      hintEl.style.display = 'block';
      hintEl.textContent = `Photo saved ‚Äî ${queueCount} queued for when you're online`;
      hintEl.style.color = 'var(--gold)';
      area.classList.add('success');
      toast(`Photo queued (${queueCount} total) ‚Äî will process when online`, 'success');
      updatePhotoQueueBadge();
      input.value = '';
      return;
    }

    barEl.style.width = '30%';
    statusEl.textContent = 'Loading OCR‚Ä¶';

    if (!window.Tesseract) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js');
    }

    statusEl.textContent = 'Reading label‚Ä¶';
    barEl.style.width = '50%';

    // Reconstruct File from base64 for Tesseract
    const dataUrl = 'data:image/png;base64,' + base64;
    const result = await Tesseract.recognize(dataUrl, 'eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          barEl.style.width = (50 + m.progress * 40) + '%';
        }
      },
      // PSM 3 = fully automatic page segmentation (best for labels)
      // OEM 1 = LSTM neural net only (most accurate)
      tessedit_pageseg_mode: '3',
      tessedit_ocr_engine_mode: '1',
    });

    barEl.style.width = '100%';
    area.classList.remove('processing');
    progressEl.classList.remove('visible');
    area.classList.add('success');
    hintEl.style.display = 'block';
    hintEl.textContent = 'Tap to rescan';

    const rawText = result.data.text;
    const parsed = parseLabelText(rawText);
    showLabelReview(parsed, rawText);

  } catch(e) {
    console.error(e);
    area.classList.remove('processing');
    progressEl.classList.remove('visible');
    hintEl.style.display = 'block';
    hintEl.textContent = 'Could not read label ‚Äî try again or enter manually';
    toast('Label scan failed ‚Äî try again', 'error');
  }

  input.value = '';
}

// ===========================
// PASTE / LIVE TEXT
// ===========================
function openPastePanel() {
  document.getElementById('paste-panel').style.display = 'block';
  document.getElementById('paste-area').style.display = 'none';
  setTimeout(() => document.getElementById('paste-input').focus(), 100);
}

function closePastePanel() {
  document.getElementById('paste-panel').style.display = 'none';
  document.getElementById('paste-area').style.display = 'block';
  document.getElementById('paste-input').value = '';
}

function processPastedText() {
  const text = document.getElementById('paste-input').value.trim();
  if (!text) { toast('Paste some label text first', 'error'); return; }
  const parsed = parseLabelText(text);
  showLabelReview(parsed, text);
  const pa = document.getElementById('paste-area');
  pa.style.display = 'block';
  pa.classList.add('success');
  closePastePanel();
  toast('Label text parsed ‚úì', 'success');
}

// Preprocess image for OCR: upscale, greyscale, sharpen, boost contrast
function resizeImageToBase64(file, maxDim) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);

      // Scale UP small images, cap large ones at maxDim
      const scale = Math.min(maxDim / Math.max(img.width, img.height), 3.0);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      // Step 1: draw at scale
      const c1 = document.createElement('canvas');
      c1.width = w; c1.height = h;
      const ctx1 = c1.getContext('2d');
      ctx1.drawImage(img, 0, 0, w, h);

      // Step 2: convert to greyscale + boost contrast via pixel manipulation
      const imageData = ctx1.getImageData(0, 0, w, h);
      const d = imageData.data;
      for (let i = 0; i < d.length; i += 4) {
        // Greyscale using luminance weights
        let v = 0.299 * d[i] + 0.587 * d[i+1] + 0.114 * d[i+2];
        // S-curve contrast boost ‚Äî pulls midtones toward extremes
        v = v / 255;
        v = v < 0.5
          ? 2 * v * v
          : 1 - Math.pow(-2 * v + 2, 2) / 2;
        v = Math.round(v * 255);
        // Extra brightness lift for dark images
        v = Math.min(255, v * 1.15);
        d[i] = d[i+1] = d[i+2] = v;
      }
      ctx1.putImageData(imageData, 0, 0);

      // Step 3: unsharp mask ‚Äî draw on a second canvas with blur then subtract
      const c2 = document.createElement('canvas');
      c2.width = w; c2.height = h;
      const ctx2 = c2.getContext('2d');
      ctx2.filter = 'blur(1.5px)';
      ctx2.drawImage(c1, 0, 0);
      ctx2.filter = 'none';

      const sharp = ctx1.getImageData(0, 0, w, h);
      const blurred = ctx2.getImageData(0, 0, w, h);
      const sd = sharp.data, bd = blurred.data;
      const amount = 1.8; // sharpening strength
      for (let i = 0; i < sd.length; i += 4) {
        const s = sd[i], b = bd[i];
        const sharpened = Math.min(255, Math.max(0, s + amount * (s - b)));
        sd[i] = sd[i+1] = sd[i+2] = sharpened;
      }
      ctx1.putImageData(sharp, 0, 0);

      resolve(c1.toDataURL('image/png').split(',')[1]);
    };
    img.onerror = reject;
    img.src = url;
  });
}

// ===========================
// TESSERACT OCR + LABEL PARSER
// ===========================
function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

function parseLabelText(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 1);
  const allText = lines.join(' ');
  const result = { _lines: lines };

  // VINTAGE
  const vintageMatch = allText.match(/\b(19[5-9]\d|20[0-2]\d)\b/);
  if (vintageMatch) result.vintage = parseInt(vintageMatch[1]);

  // VARIETALS
  const varietals = [
    'Cabernet Sauvignon','Cabernet Franc','Sauvignon Blanc','Pinot Noir','Pinot Grigio','Pinot Gris',
    'Chardonnay','Merlot','Syrah','Shiraz','Grenache','Malbec','Tempranillo','Zinfandel',
    'Riesling','Gewurztraminer','Viognier','Chenin Blanc','Sangiovese','Nebbiolo','Barbera',
    'Mourvedre','Roussanne','Marsanne','Gruner Veltliner','Torrontes','Carmenere','Petit Verdot',
    'Petite Sirah','Gamay','Muscat','Moscato','Prosecco','Montepulciano','Primitivo',
    'Vermentino','Fiano','Greco','Nero d\'Avola','Bombino Nero','Aglianico','Falanghina'
  ];
  for (const v of varietals) {
    if (new RegExp('\\b' + v + '\\b', 'i').test(allText)) { result.varietal = v; break; }
  }

  // TYPE
  const typeMap = {
    'ros√©': ['ros√©','rosato','rosat','rosado'],
    sparkling: ['spumante','prosecco','champagne','cava','cr√©mant','cremant','sekt','frizzante'],
    white: ['blanc','bianco','blanco','weiss','white'],
    red: ['rouge','rosso','tinto','rotwein','red'],
    dessert: ['passito','late harvest','eiswein','sauternes'],
    fortified: ['port','sherry','madeira','marsala']
  };
  for (const [type, kws] of Object.entries(typeMap)) {
    if (kws.some(k => allText.toLowerCase().includes(k))) { result.type = type; break; }
  }
  if (!result.type && result.varietal) {
    const whites = ['sauvignon blanc','chardonnay','pinot grigio','pinot gris','riesling','gewurztraminer','viognier','chenin blanc','gruner veltliner','torrontes','roussanne','marsanne','vermentino','fiano','greco','muscat','moscato','falanghina'];
    result.type = whites.includes(result.varietal.toLowerCase()) ? 'white' : 'red';
  }

  // REGIONS
  const regions = [
    'Castel del Monte','Bordeaux','Burgundy','Bourgogne','Champagne','Rh√¥ne','Alsace','Loire',
    'Provence','Napa Valley','Sonoma','Willamette Valley','Paso Robles','Barossa Valley',
    'McLaren Vale','Margaret River','Tuscany','Toscana','Piedmont','Piemonte','Veneto',
    'Sicilia','Puglia','Rioja','Ribera del Duero','Priorat','Mendoza','Douro','Alentejo',
    'Mosel','Marlborough','Central Otago','Stellenbosch','Ch√¢teauneuf-du-Pape',
    'C√¥tes du Rh√¥ne','Saint-√âmilion','Pomerol','Pauillac','Margaux','Chablis','Beaujolais'
  ];
  for (const r of regions) {
    if (new RegExp('\\b' + r.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i').test(allText)) {
      result.region = r; break;
    }
  }

  // COUNTRY
  const countries = {
    'Italy': ['italy','italia','d.o.c','doc','docg','igt'],
    'France': ['france','vin de france','aoc','a.o.c'],
    'Spain': ['spain','espa√±a','do ','d.o.'],
    'USA': ['california','oregon','washington','napa','sonoma'],
    'Australia': ['australia'],
    'Argentina': ['argentina','mendoza'],
    'Chile': ['chile'],
    'New Zealand': ['new zealand'],
    'Portugal': ['portugal','douro','alentejo'],
    'Germany': ['germany','deutschland','mosel','rheingau'],
    'South Africa': ['south africa','stellenbosch'],
    'Austria': ['austria','√∂sterreich']
  };
  for (const [country, kws] of Object.entries(countries)) {
    if (kws.some(k => allText.toLowerCase().includes(k))) { result.country = country; break; }
  }

  // NAME + PRODUCER from best lines
  const skipRe = /^(wine|vin|vino|product|imported|contains|sulfites|government|warning|alcohol|serve|store|bottled|produce|appellation|denominazione|qualit√§tswein|mis en|d\.?o\.?c\.?|i\.?g\.?t\.?)$/i;
  const goodLines = lines.filter(l => {
    if (l.length < 3 || l.length > 60) return false;
    if (/^\d+(\.\d+)?\s*(%|ml|cl|l|oz)$/i.test(l)) return false;
    if (/^\d{4}$/.test(l)) return false;
    if (l.split(' ').length === 1 && skipRe.test(l)) return false;
    return true;
  });

  const scored = goodLines.map(l => {
    let score = 0;
    if (/^[A-Z]/.test(l)) score += 2;
    if (/^[A-Z][a-z]/.test(l)) score += 1; // Title case ‚Äî likely a proper name
    if (/ch√¢teau|chateau|domaine|bodega|cantina|weingut|estate|winery|cellars?|rivera|cantine/i.test(l)) score += 3;
    score += Math.min(l.length / 8, 4);
    return { line: l, score };
  }).sort((a, b) => b.score - a.score);

  if (scored.length > 0) {
    const top = scored[0].line;
    if (/ch√¢teau|chateau|domaine|bodega|cantina|weingut|estate|winery|cellars?|rivera|cantine/i.test(top)) {
      result.producer = top;
      if (scored[1]) result.name = scored[1].line;
    } else {
      result.name = top;
      if (scored[1]) result.producer = scored[1].line;
    }
  }

  return result;
}

// Review panel ‚Äî shows parsed results + all text lines for user to confirm/reassign
function showLabelReview(parsed, rawText) {
  const existing = document.getElementById('label-review-panel');
  if (existing) existing.remove();

  // Clean lines ‚Äî filter OCR garbage, deduplicate, keep only plausible text
  const allLines = (parsed._lines || rawText.split('\n')).map(l => l.trim());
  const lines = allLines.filter((l, i, arr) => {
    if (l.length < 2) return false;
    if (arr.indexOf(l) !== i) return false; // deduplicate
    // Remove lines that are >60% non-alphabetic (likely OCR noise)
    const alphaCount = (l.match(/[a-zA-Z√Ä-√ø]/g) || []).length;
    if (alphaCount / l.length < 0.4) return false;
    // Remove lines with too many consecutive numbers (not wine-relevant)
    if (/\d{6,}/.test(l)) return false;
    // Remove very long garbled lines
    if (l.length > 50 && alphaCount / l.length < 0.6) return false;
    return true;
  });

  const fields = [
    { id: 'f-name',     label: 'Wine Name',  val: parsed.name     || '' },
    { id: 'f-producer', label: 'Producer',   val: parsed.producer || '' },
    { id: 'f-vintage',  label: 'Vintage',    val: parsed.vintage  || '' },
    { id: 'f-varietal', label: 'Varietal',   val: parsed.varietal || '' },
    { id: 'f-region',   label: 'Region',     val: parsed.region   || '' },
    { id: 'f-country',  label: 'Country',    val: parsed.country  || '' },
  ];

  const panel = document.createElement('div');
  panel.id = 'label-review-panel';
  panel.style.cssText = `
    position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:400;
    display:flex;align-items:flex-end;justify-content:center;
  `;

  panel.innerHTML = `
    <div style="
      background:var(--bg2);border-top:1px solid var(--border-light);
      width:100%;max-width:600px;max-height:85vh;overflow-y:auto;
      border-radius:4px 4px 0 0;padding:20px;
    ">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
        <div style="font-family:var(--font-serif);font-size:22px;font-style:italic;color:var(--cream)">Review Label</div>
        <button onclick="applyLabelReview()" style="
          background:var(--wine);border:1px solid var(--wine-light);color:var(--cream);
          font-family:var(--font-mono);font-size:10px;letter-spacing:0.12em;
          padding:7px 16px;cursor:pointer;border-radius:2px;
        ">APPLY & CLOSE</button>
      </div>

      <div style="margin-bottom:16px">
        <div style="font-size:9px;letter-spacing:0.15em;color:var(--text-muted);margin-bottom:10px;text-transform:uppercase">Detected Fields ‚Äî tap any text below to reassign</div>
        ${fields.map(f => `
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <div style="font-size:9px;letter-spacing:0.12em;color:var(--text-muted);text-transform:uppercase;width:68px;flex-shrink:0">${f.label}</div>
            <input id="review-${f.id}" value="${f.val}" placeholder="‚Äî"
              style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--cream);
              font-family:var(--font-mono);font-size:12px;padding:6px 10px;border-radius:2px;outline:none">
          </div>
        `).join('')}
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <div style="font-size:9px;letter-spacing:0.12em;color:var(--text-muted);text-transform:uppercase;width:68px;flex-shrink:0">Type</div>
          <select id="review-f-type" style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--cream);font-family:var(--font-mono);font-size:12px;padding:6px 10px;border-radius:2px;outline:none">
            ${['red','white','ros√©','sparkling','orange','dessert','fortified'].map(t =>
              `<option value="${t}" ${parsed.type === t ? 'selected' : ''}>${t.charAt(0).toUpperCase()+t.slice(1)}</option>`
            ).join('')}
          </select>
        </div>
      </div>

      <div>
        <div style="font-size:9px;letter-spacing:0.15em;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase">All Text Found ‚Äî tap a line to copy to a field</div>
        <div id="raw-lines" style="display:flex;flex-wrap:wrap;gap:6px">
          ${lines.map(l => `
            <div onclick="selectRawLine('${l.replace(/'/g,"\\'")}', this)" style="
              padding:4px 10px;background:var(--bg3);border:1px solid var(--border);
              border-radius:2px;font-size:11px;color:var(--cream-dim);cursor:pointer;
              transition:all 0.1s;
            " onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='var(--border)'">${l}</div>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  // Tap a raw line ‚Üí prompt which field to assign it to
  document.body.appendChild(panel);
  panel.addEventListener('click', e => { if (e.target === panel) panel.remove(); });
}

let _selectedLine = '';
function selectRawLine(line, el) {
  _selectedLine = line;
  document.querySelectorAll('#raw-lines > div').forEach(d => d.style.borderColor = 'var(--border)');
  el.style.borderColor = 'var(--gold)';
  el.style.color = 'var(--gold)';

  // Show a small assign menu
  const existing = document.getElementById('assign-menu');
  if (existing) existing.remove();

  const fields = [
    { id: 'review-f-name', label: 'Wine Name' },
    { id: 'review-f-producer', label: 'Producer' },
    { id: 'review-f-vintage', label: 'Vintage' },
    { id: 'review-f-varietal', label: 'Varietal' },
    { id: 'review-f-region', label: 'Region' },
    { id: 'review-f-country', label: 'Country' },
  ];

  const menu = document.createElement('div');
  menu.id = 'assign-menu';
  menu.style.cssText = `
    position:fixed;bottom:0;left:0;right:0;background:var(--bg3);
    border-top:1px solid var(--border-light);z-index:500;
    padding:12px 20px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;
    max-width:600px;margin:0 auto;
  `;
  menu.innerHTML = `
    <span style="font-size:10px;color:var(--text-muted);letter-spacing:0.1em;width:100%;margin-bottom:2px">ASSIGN "${line.slice(0,30)}" TO:</span>
    ${fields.map(f => `
      <button onclick="assignLineTo('${f.id}')" style="
        padding:5px 12px;background:none;border:1px solid var(--border);color:var(--cream-dim);
        font-family:var(--font-mono);font-size:10px;letter-spacing:0.08em;cursor:pointer;border-radius:2px;
      ">${f.label}</button>
    `).join('')}
    <button onclick="document.getElementById('assign-menu').remove()" style="
      padding:5px 10px;background:none;border:none;color:var(--text-muted);
      font-family:var(--font-mono);font-size:10px;cursor:pointer;margin-left:auto;
    ">‚úï</button>
  `;
  document.body.appendChild(menu);
}

function assignLineTo(fieldId) {
  const input = document.getElementById(fieldId);
  if (input) { input.value = _selectedLine; input.style.borderColor = 'var(--gold)'; }
  document.getElementById('assign-menu')?.remove();
}

function applyLabelReview() {
  const map = {
    'review-f-name': 'f-name',
    'review-f-producer': 'f-producer',
    'review-f-vintage': 'f-vintage',
    'review-f-varietal': 'f-varietal',
    'review-f-region': 'f-region',
    'review-f-country': 'f-country',
  };
  let filled = 0;
  for (const [reviewId, formId] of Object.entries(map)) {
    const val = document.getElementById(reviewId)?.value?.trim();
    if (val) { document.getElementById(formId).value = val; filled++; }
  }
  const type = document.getElementById('review-f-type')?.value;
  if (type) document.getElementById('f-type').value = type;

  document.getElementById('label-review-panel')?.remove();
  document.getElementById('assign-menu')?.remove();
  toast(`${filled} field${filled !== 1 ? 's' : ''} applied ‚úì`, 'success');
}

// ===========================
// PHOTO QUEUE
// ===========================
async function updatePhotoQueueBadge() {
  const count = await db.photoQueue.where('processed').equals(0).count();
  const badge = document.getElementById('pending-count');
  if (count > 0) { badge.textContent = count + ' photo' + (count > 1 ? 's' : ''); badge.style.display = 'inline'; }
  else { updatePendingCount(); } // fall back to sync queue count
}

async function processPhotoQueue() {
  const pending = await db.photoQueue.where('processed').equals(0).toArray();
  if (pending.length === 0) return;

  // Show processing banner
  const existing = document.getElementById('photo-queue-banner');
  if (existing) existing.remove();

  const banner = document.createElement('div');
  banner.id = 'photo-queue-banner';
  banner.style.cssText = `
    position:fixed;top:56px;left:0;right:0;z-index:998;
    background:#1f1109;border-bottom:1px solid #c4952a;
    padding:10px 20px;font-family:'Inconsolata',monospace;
    font-size:11px;letter-spacing:0.08em;color:#e8dcc8;
  `;
  banner.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span>üì∑ Processing ${pending.length} queued photo${pending.length > 1 ? 's' : ''}‚Ä¶</span>
      <span id="pq-counter" style="color:var(--gold)">0 / ${pending.length}</span>
    </div>
    <div style="height:2px;background:var(--border);border-radius:1px;overflow:hidden">
      <div id="pq-bar" style="height:100%;background:#c4952a;width:0%;transition:width 0.4s ease"></div>
    </div>
  `;
  document.body.appendChild(banner);

  let done = 0;
  for (const item of pending) {
    try {
      if (!window.Tesseract) {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js');
      }
      const dataUrl = 'data:image/png;base64,' + item.base64;
      const result = await Tesseract.recognize(dataUrl, 'eng', {
        tessedit_pageseg_mode: '3',
        tessedit_ocr_engine_mode: '1',
      });
      const parsed = parseLabelText(result.data.text);
      await db.photoQueue.update(item.id, { processed: 1, result: JSON.stringify(parsed) });
    } catch(e) {
      await db.photoQueue.update(item.id, { processed: 2 }); // 2 = failed
    }
    done++;
    document.getElementById('pq-counter').textContent = `${done} / ${pending.length}`;
    document.getElementById('pq-bar').style.width = `${(done/pending.length)*100}%`;
  }

  banner.remove();
  showPhotoQueueResults();
}

async function showPhotoQueueResults() {
  const processed = await db.photoQueue.where('processed').equals(1).toArray();
  if (processed.length === 0) { toast('No queued photos could be processed', 'error'); return; }

  // Open a review modal with all results
  const overlay = document.createElement('div');
  overlay.id = 'pq-modal';
  overlay.style.cssText = `
    position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:400;
    display:flex;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;
  `;

  const cards = processed.map(item => {
    const r = JSON.parse(item.result || '{}');
    return `
      <div class="pq-card" data-id="${item.id}" style="
        background:var(--bg2);border:1px solid var(--border);border-radius:2px;
        padding:16px;margin-bottom:12px;position:relative;
      ">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <img src="data:image/jpeg;base64,${item.base64}"
            style="width:80px;height:80px;object-fit:cover;border-radius:2px;flex-shrink:0;border:1px solid var(--border)">
          <div style="flex:1;min-width:0">
            <div style="font-family:var(--font-serif);font-size:17px;color:var(--cream);margin-bottom:2px">
              ${r.name || '(Unknown)'}
            </div>
            <div style="font-size:10px;color:var(--text-dim);margin-bottom:8px">
              ${[r.producer, r.vintage, r.varietal].filter(Boolean).join(' ¬∑ ')}
            </div>
            <div style="font-size:10px;color:var(--text-muted)">
              ${[r.region, r.country].filter(Boolean).join(', ')}
            </div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">
          <button onclick="addFromQueue(${item.id})" style="
            flex:1;padding:7px;background:var(--wine);border:1px solid var(--wine-light);
            color:var(--cream);font-family:var(--font-mono);font-size:10px;
            letter-spacing:0.1em;cursor:pointer;border-radius:2px;
          ">ADD TO CELLAR</button>
          <button onclick="dismissQueueItem(${item.id})" style="
            padding:7px 12px;background:none;border:1px solid var(--border);
            color:var(--text-muted);font-family:var(--font-mono);font-size:10px;
            letter-spacing:0.1em;cursor:pointer;border-radius:2px;
          ">SKIP</button>
        </div>
      </div>
    `;
  }).join('');

  overlay.innerHTML = `
    <div style="width:100%;max-width:520px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div style="font-family:var(--font-serif);font-size:24px;font-style:italic;color:var(--cream)">
          Queued Bottles
        </div>
        <button onclick="document.getElementById('pq-modal').remove()" style="
          background:none;border:1px solid var(--border);color:var(--text-muted);
          padding:6px 10px;font-family:var(--font-mono);font-size:10px;cursor:pointer;border-radius:2px;
        ">DONE</button>
      </div>
      ${cards}
    </div>
  `;
  document.body.appendChild(overlay);
  updatePhotoQueueBadge();
}

async function addFromQueue(queueId) {
  const item = await db.photoQueue.get(queueId);
  if (!item) return;
  const r = JSON.parse(item.result || '{}');

  // Switch to add tab
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelector('[data-view="add"]').classList.add('active');
  document.getElementById('view-add').classList.add('active');

  // Show photo preview
  const preview = document.getElementById('label-preview');
  preview.src = 'data:image/jpeg;base64,' + item.base64;
  preview.style.display = 'block';

  populateRackSelect();
  await db.photoQueue.delete(queueId);
  document.getElementById('pq-modal')?.remove();
  updatePhotoQueueBadge();

  // Open the review panel so user can confirm/adjust
  showLabelReview(r, (r._lines || []).join('\n'));
}

async function dismissQueueItem(queueId) {
  await db.photoQueue.delete(queueId);
  const card = document.querySelector(`.pq-card[data-id="${queueId}"]`);
  if (card) card.remove();
  updatePhotoQueueBadge();
  // Close if no more cards
  const remaining = document.querySelectorAll('.pq-card');
  if (remaining.length === 0) document.getElementById('pq-modal')?.remove();
}

async function enrichFromSearch(parsed) {
  try {
    const query = [parsed.name, parsed.producer, parsed.vintage].filter(Boolean).join(' ');
    const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&categories_tags=wines&json=1&page_size=1&fields=product_name,brands,origins,countries,ingredients_text`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.products && data.products[0]) {
      const p = data.products[0];
      if (p.origins && !document.getElementById('f-region').value)
        document.getElementById('f-region').value = p.origins;
      if (p.countries && !document.getElementById('f-country').value)
        document.getElementById('f-country').value = p.countries;
      if (p.ingredients_text && !document.getElementById('f-notes').value)
        document.getElementById('f-notes').value = p.ingredients_text;
    }
  } catch(e) {}
}

// ===========================
// CELLAR MAP
// ===========================
function renderCellarTabs() {
  const sel = document.getElementById('rack-selector');
  sel.innerHTML = racks.map(r => `
    <button class="rack-tab ${r.id === currentRackId ? 'active' : ''}" onclick="selectRack(${r.id})">${r.name}</button>
  `).join('');
}

function selectRack(id) {
  currentRackId = id;
  renderCellarTabs();
  renderCellar();
}

function renderCellar() {
  renderCellarTabs();
  const rack = racks.find(r => r.id === currentRackId);
  if (!rack) return;

  const grid = document.getElementById('rack-grid');
  const colLabels = document.getElementById('rack-col-labels');
  const rowLabels = document.getElementById('rack-row-labels');

  grid.style.gridTemplateColumns = `repeat(${rack.cols}, 44px)`;
  grid.style.gridTemplateRows = `repeat(${rack.rows}, 44px)`;

  // Column labels
  colLabels.innerHTML = Array.from({length: rack.cols}, (_,i) =>
    `<div style="width:44px;text-align:center;font-size:9px;color:var(--text-muted);letter-spacing:0">${i+1}</div>`
  ).join('');

  // Row labels
  rowLabels.innerHTML = Array.from({length: rack.rows}, (_,i) =>
    `<div style="height:44px;width:28px;display:flex;align-items:center;justify-content:flex-end;font-size:9px;color:var(--text-muted);letter-spacing:0">${i+1}</div>`
  ).join('');

  // Build slot map
  const slotMap = {};
  bottles.forEach(b => {
    if (b.rack == currentRackId && b.row && b.col) {
      slotMap[`${b.row}-${b.col}`] = b;
    }
  });

  grid.innerHTML = '';
  for (let r = 1; r <= rack.rows; r++) {
    for (let c = 1; c <= rack.cols; c++) {
      const key = `${r}-${c}`;
      const b = slotMap[key];
      const slot = document.createElement('div');
      slot.className = `rack-slot${b ? ' occupied ' + (b.type || '') : ''}`;
      const tierHtml = (b && b.priceTier) ? `<div class="rack-slot-tier">${b.priceTier}</div>` : '';
      slot.innerHTML = `<div class="rack-slot-dot"></div>${tierHtml}`;
      slot.dataset.row = r;
      slot.dataset.col = c;
      if (b) {
        slot.addEventListener('mouseenter', (e) => showTooltip(e, b));
        slot.addEventListener('mouseleave', hideTooltip);
        slot.addEventListener('click', () => openBottle(b.id));
      } else {
        slot.addEventListener('click', () => assignSlot(r, c));
        slot.title = `R${r}C${c} ‚Äî Empty`;
      }
      grid.appendChild(slot);
    }
  }
}

function showTooltip(e, b) {
  const tt = document.getElementById('slot-tooltip');
  document.getElementById('tt-name').textContent = b.name || 'Unknown';
  document.getElementById('tt-meta').textContent = [b.vintage, capitalize(b.type), b.varietal].filter(Boolean).join(' ¬∑ ');
  tt.classList.add('visible');
  moveTooltip(e);
}

function moveTooltip(e) {
  const tt = document.getElementById('slot-tooltip');
  tt.style.left = (e.clientX + 12) + 'px';
  tt.style.top = (e.clientY - 30) + 'px';
}

function hideTooltip() {
  document.getElementById('slot-tooltip').classList.remove('visible');
}

function assignSlot(row, col) {
  // Switch to add tab with location pre-filled
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelector('[data-view="add"]').classList.add('active');
  document.getElementById('view-add').classList.add('active');
  populateRackSelect();
  document.getElementById('f-rack').value = currentRackId;
  document.getElementById('f-row').value = row;
  document.getElementById('f-col').value = col;
  toast(`Pre-filled location: R${row}C${col}`);
}

// ===========================
// STATS
// ===========================
function renderStats() {
  const total = bottles.length;
  document.getElementById('stat-total').textContent = total;

  const totalValue = bottles.reduce((s, b) => s + (b.marketValue || b.purchasePrice || 0), 0);
  document.getElementById('stat-value').textContent = totalValue ? '$' + totalValue.toLocaleString(undefined, {maximumFractionDigits:0}) : '‚Äî';

  const scores = bottles.filter(b => b.score).map(b => b.score);
  const avgScore = scores.length ? Math.round(scores.reduce((a,b) => a+b, 0) / scores.length) : null;
  document.getElementById('stat-avg-score').textContent = avgScore || '‚Äî';

  // By type
  const types = ['red','white','ros√©','sparkling','orange','dessert','fortified'];
  const typeColors = { red:'', white:'gold', ros√©:'rose', sparkling:'sparkling', orange:'orange' };
  const typeCounts = {};
  types.forEach(t => typeCounts[t] = bottles.filter(b => b.type === t).length);
  const maxType = Math.max(...Object.values(typeCounts), 1);
  document.getElementById('chart-type').innerHTML = types.filter(t => typeCounts[t] > 0).map(t => `
    <div class="bar-row">
      <div class="bar-label">${capitalize(t)}</div>
      <div class="bar-track"><div class="bar-fill ${typeColors[t] || ''}" style="width:${(typeCounts[t]/maxType)*100}%"></div></div>
      <div class="bar-count">${typeCounts[t]}</div>
    </div>
  `).join('') || '<div style="color:var(--text-muted);font-size:11px">No data</div>';

  // By decade
  const decades = {};
  bottles.filter(b => b.vintage).forEach(b => {
    const d = Math.floor(b.vintage / 10) * 10;
    decades[d] = (decades[d] || 0) + 1;
  });
  const maxDec = Math.max(...Object.values(decades), 1);
  document.getElementById('chart-decade').innerHTML = Object.entries(decades).sort((a,b) => b[0]-a[0]).map(([d,c]) => `
    <div class="bar-row">
      <div class="bar-label">${d}s</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(c/maxDec)*100}%"></div></div>
      <div class="bar-count">${c}</div>
    </div>
  `).join('') || '<div style="color:var(--text-muted);font-size:11px">No vintage data</div>';

  // By region
  const regions = {};
  bottles.filter(b => b.region).forEach(b => {
    regions[b.region] = (regions[b.region] || 0) + 1;
  });
  const maxReg = Math.max(...Object.values(regions), 1);
  document.getElementById('chart-region').innerHTML = Object.entries(regions).sort((a,b) => b[1]-a[1]).slice(0,8).map(([r,c]) => `
    <div class="bar-row">
      <div class="bar-label" style="width:100px;font-size:9px">${r}</div>
      <div class="bar-track"><div class="bar-fill gold" style="width:${(c/maxReg)*100}%"></div></div>
      <div class="bar-count">${c}</div>
    </div>
  `).join('') || '<div style="color:var(--text-muted);font-size:11px">No region data</div>';
}

// ===========================
// SYNC STATUS
// ===========================
function updateSyncStatus(state) {
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-label');
  const ghBtn = document.getElementById('github-btn');

  if (state === 'syncing') {
    dot.className = 'sync-dot syncing';
    label.textContent = 'SYNCING';
    return;
  }
  if (navigator.onLine) {
    dot.className = 'sync-dot online';
    label.textContent = ghConfig ? 'GITHUB' : 'ONLINE';
    if (ghBtn) ghBtn.style.color = ghConfig ? 'var(--gold)' : 'var(--text-muted)';
    updatePendingCount();
  } else {
    dot.className = 'sync-dot';
    label.textContent = 'OFFLINE';
    if (ghBtn) ghBtn.style.color = 'var(--text-muted)';
    updatePendingCount();
  }
}

// ===========================
// MODAL
// ===========================
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ===========================
// TOAST
// ===========================
function toast(msg, type = '') {
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ===========================
// UTILS
// ===========================
function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

// ===========================
// GITHUB SYNC
// ===========================

async function loadGithubConfig() {
  try {
    const settings = await db.table('settings').toArray().catch(() => []);
    const cfg = settings.find(s => s.key === 'githubConfig');
    if (cfg) {
      ghConfig = cfg.value;
      updateGithubModalUI();
      updateSyncStatus();
    }
  } catch(e) {}
}

async function saveGithubConfig() {
  const username = document.getElementById('gh-username').value.trim();
  const repo = document.getElementById('gh-repo').value.trim();
  const token = document.getElementById('gh-token').value.trim();

  if (!username || !repo || !token) {
    toast('Please fill in all fields', 'error'); return;
  }

  // Test the token with a lightweight API call
  toast('Verifying token‚Ä¶');
  try {
    const test = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
      headers: { Authorization: `token ${token}`, 'User-Agent': 'Cave-WineCellar' }
    });
    if (!test.ok) {
      toast('Could not access repo ‚Äî check username, repo name, and token', 'error');
      return;
    }
  } catch(e) {
    toast('Network error ‚Äî check your connection', 'error'); return;
  }

  ghConfig = { username, repo, token };

  // Store in settings table
  try {
    await db.table('settings').put({ key: 'githubConfig', value: ghConfig });
  } catch(e) {
    // settings table may not exist yet ‚Äî add to db version
    toast('Please reload the app after this first save', 'error');
  }

  updateGithubModalUI();
  updateSyncStatus();
  closeModal('github-modal');
  toast('GitHub connected ‚úì', 'success');

  // If we have local bottles, push them ‚Äî otherwise pull (fresh install)
  const localCount = await db.bottles.count();
  if (localCount > 0) {
    await githubPush({ silent: false });
  } else {
    toast('No local data ‚Äî pulling from GitHub‚Ä¶');
    await githubPull({ silent: false });
  }
}

function updateGithubModalUI() {
  const setup = document.getElementById('github-setup-view');
  const status = document.getElementById('github-status-view');
  if (!setup || !status) return;
  if (ghConfig) {
    setup.style.display = 'none';
    status.style.display = 'block';
    document.getElementById('gh-status-repo').textContent = `${ghConfig.username}/${ghConfig.repo}`;
    document.getElementById('gh-status-detail').textContent = `data/cellar.json ¬∑ auto-sync on`;
  } else {
    setup.style.display = 'block';
    status.style.display = 'none';
  }
}

function openGithubSetup() {
  updateGithubModalUI();
  if (ghConfig) {
    // Pre-fill fields in case they want to update
    document.getElementById('gh-username').value = ghConfig.username || '';
    document.getElementById('gh-repo').value = ghConfig.repo || '';
  }
  document.getElementById('github-modal').classList.add('open');
}

async function disconnectGithub() {
  if (!confirm('Disconnect GitHub? Your local data stays intact.')) return;
  ghConfig = null;
  try { await db.table('settings').delete('githubConfig'); } catch(e) {}
  updateGithubModalUI();
  updateSyncStatus();
  closeModal('github-modal');
  toast('GitHub disconnected');
}

// Push all local data to GitHub as data/cellar.json
async function githubPush({ silent = false } = {}) {
  if (!ghConfig || !navigator.onLine) return;

  if (!silent) updateSyncStatus('syncing');

  try {
    const { username, repo, token } = ghConfig;
    const path = 'data/cellar.json';
    const apiBase = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
    const headers = {
      Authorization: `token ${token}`,
      'Content-Type': 'application/json',
      'User-Agent': 'Cave-WineCellar'
    };

    // Build the payload ‚Äî all bottles + racks
    const allBottles = await db.bottles.toArray();
    const allRacks = await db.racks.toArray();
    const payload = {
      version: APP_VERSION,
      exportedAt: new Date().toISOString(),
      racks: allRacks,
      bottles: allBottles
    };
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));

    // Get current SHA (needed to update existing file)
    let sha = null;
    try {
      const existing = await fetch(apiBase, { headers });
      if (existing.ok) {
        const data = await existing.json();
        sha = data.sha;
      }
    } catch(e) {}

    const body = {
      message: `Update cellar ‚Äî ${allBottles.length} bottle${allBottles.length !== 1 ? 's' : ''} ¬∑ v${APP_VERSION}`,
      content: encoded,
      ...(sha ? { sha } : {})
    };

    const resp = await fetch(apiBase, {
      method: 'PUT',
      headers,
      body: JSON.stringify(body)
    });

    if (!resp.ok) {
      const err = await resp.json();
      throw new Error(err.message || 'Push failed');
    }

    if (!silent) {
      updateSyncStatus();
      toast(`Pushed to GitHub ‚úì (${allBottles.length} bottles)`, 'success');
    } else {
      updateSyncStatus();
    }
  } catch(e) {
    console.error('GitHub push error:', e);
    updateSyncStatus();
    if (!silent) toast('GitHub push failed: ' + e.message, 'error');
  }
}

// Pull data/cellar.json from GitHub and merge into local DB
async function githubPull({ silent = false } = {}) {
  if (!ghConfig || !navigator.onLine) return;

  if (!silent) updateSyncStatus('syncing');

  try {
    const { username, repo, token } = ghConfig;
    const path = 'data/cellar.json';
    const apiBase = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
    const headers = {
      Authorization: `token ${token}`,
      'User-Agent': 'Cave-WineCellar'
    };

    const resp = await fetch(apiBase, { headers });
    if (resp.status === 404) {
      // File doesn't exist yet ‚Äî push current data
      await loadBottles();
      updateSyncStatus();
      if (!silent) toast('No remote data yet ‚Äî will create on next save');
      return;
    }
    if (!resp.ok) throw new Error('Pull failed: ' + resp.status);

    const data = await resp.json();
    const json = JSON.parse(decodeURIComponent(escape(atob(data.content.replace(/\n/g, '')))));

    // Restore racks first (clear and replace)
    if (json.racks && json.racks.length > 0) {
      await db.racks.clear();
      for (const r of json.racks) {
        const { id, ...rackData } = r;
        await db.racks.add({ id, ...rackData });
      }
      racks = await db.racks.toArray();
    }

    // Restore bottles (clear and replace)
    if (json.bottles) {
      await db.bottles.clear();
      for (const b of json.bottles) {
        const { id, ...bottleData } = b;
        await db.bottles.add({ id, ...bottleData });
      }
    }

    await loadBottles();
    updateSyncStatus();
    renderCollection();
    renderStats();
    renderCellar();

    if (!silent) {
      toast(`Pulled from GitHub ‚úì ‚Äî ${json.bottles?.length || 0} bottle${json.bottles?.length !== 1 ? 's' : ''} loaded`, 'success');
    }
  } catch(e) {
    console.error('GitHub pull error:', e);
    await loadBottles();
    updateSyncStatus();
    renderCollection();
    renderStats();
    if (!silent) toast('GitHub pull failed: ' + e.message, 'error');
  }
}

// ===========================
// CSV EXPORT / IMPORT
// ===========================

const CSV_FIELDS = [
  { key: 'name',          label: 'Name' },
  { key: 'producer',      label: 'Producer' },
  { key: 'vintage',       label: 'Vintage' },
  { key: 'type',          label: 'Type' },
  { key: 'varietal',      label: 'Varietal' },
  { key: 'region',        label: 'Region' },
  { key: 'country',       label: 'Country' },
  { key: 'purchasePrice', label: 'Purchase Price' },
  { key: 'marketValue',   label: 'Market Value' },
  { key: 'quantity',      label: 'Quantity' },
  { key: 'score',         label: 'Score' },
  { key: 'critic',        label: 'Critic' },
  { key: 'drinkBy',       label: 'Drink By' },
  { key: 'priceTier',     label: 'Price Tier' },
  { key: 'rack',          label: 'Rack ID' },
  { key: 'row',           label: 'Row' },
  { key: 'col',           label: 'Col' },
  { key: 'notes',         label: 'Tasting Notes' },
  { key: 'personal',      label: 'Personal Notes' },
  { key: 'addedAt',       label: 'Date Added' },
];

function csvEscape(val) {
  if (val == null || val === '') return '';
  const s = String(val);
  // Wrap in quotes if contains comma, quote, or newline
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return '"' + s.replace(/"/g, '""') + '"';
  }
  return s;
}

async function exportCsv() {
  const allBottles = await db.bottles.toArray();
  if (allBottles.length === 0) { toast('No bottles to export', 'error'); return; }

  // Build header row ‚Äî include rack name as a friendly column alongside Rack ID
  const headers = [...CSV_FIELDS.map(f => f.label), 'Rack Name'];
  const allRacks = await db.racks.toArray();
  const rackMap = {};
  allRacks.forEach(r => rackMap[r.id] = r.name);

  const rows = allBottles.map(b => {
    const vals = CSV_FIELDS.map(f => csvEscape(b[f.key]));
    vals.push(csvEscape(b.rack ? (rackMap[b.rack] || '') : ''));
    return vals.join(',');
  });

  const csv = [headers.join(','), ...rows].join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `cave-cellar-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`Exported ${allBottles.length} bottles ‚úì`, 'success');
}

async function handleCsvImport(input) {
  const file = input.files[0];
  if (!file) return;
  input.value = '';

  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) { toast('CSV appears empty', 'error'); return; }

  // Parse header row ‚Äî map column names to field keys
  const headerRow = parseCsvLine(lines[0]);
  const labelToKey = {};
  CSV_FIELDS.forEach(f => { labelToKey[f.label.toLowerCase()] = f.key; });
  // Also accept raw key names (for round-trip compatibility)
  CSV_FIELDS.forEach(f => { labelToKey[f.key.toLowerCase()] = f.key; });

  const colMap = headerRow.map(h => labelToKey[h.trim().toLowerCase()] || null);

  const validLines = lines.slice(1).filter(l => l.trim());
  if (validLines.length === 0) { toast('No data rows found', 'error'); return; }

  // Show import preview modal
  showCsvImportPreview(colMap, headerRow, validLines);
}

function parseCsvLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i+1] === '"') { current += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes) {
      result.push(current); current = '';
    } else {
      current += ch;
    }
  }
  result.push(current);
  return result;
}

function showCsvImportPreview(colMap, headerRow, lines) {
  // Parse a few rows for preview
  const preview = lines.slice(0, 3).map(l => {
    const vals = parseCsvLine(l);
    const obj = {};
    colMap.forEach((key, i) => { if (key && vals[i] !== undefined) obj[key] = vals[i]; });
    return obj;
  });

  const existing = document.getElementById('csv-preview-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'csv-preview-modal';
  modal.className = 'modal-overlay open';
  modal.innerHTML = `
    <div class="modal" style="max-width:540px">
      <div class="modal-header">
        <div>
          <div class="modal-wine-name">Import CSV</div>
          <div class="modal-producer">${lines.length} row${lines.length !== 1 ? 's' : ''} found</div>
        </div>
        <button class="btn btn-sm btn-icon" onclick="document.getElementById('csv-preview-modal').remove()">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:12px;line-height:1.7">
          Previewing first ${Math.min(3, lines.length)} row${lines.length > 1 ? 's' : ''}. Choose whether to merge with your existing collection or replace it entirely.
        </div>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:12px;margin-bottom:16px;overflow-x:auto">
          ${preview.map(b => `
            <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border);font-size:11px;color:var(--cream-dim)">
              <span style="color:var(--cream);font-family:var(--font-serif);font-size:14px">${b.name || '(no name)'}</span>
              ${b.producer ? ` ¬∑ ${b.producer}` : ''}
              ${b.vintage ? ` ¬∑ ${b.vintage}` : ''}
              ${b.type ? ` ¬∑ <span style="color:var(--wine-light)">${b.type}</span>` : ''}
            </div>
          `).join('')}
          ${lines.length > 3 ? `<div style="font-size:10px;color:var(--text-muted)">‚Ä¶and ${lines.length - 3} more</div>` : ''}
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sm" onclick="document.getElementById('csv-preview-modal').remove()">Cancel</button>
          <button class="btn btn-sm" onclick="commitCsvImport(${JSON.stringify(colMap).replace(/"/g,'&quot;')}, ${JSON.stringify(lines).replace(/"/g,'&quot;')}, 'merge')" style="border-color:var(--gold);color:var(--gold)">Merge with existing</button>
          <button class="btn btn-sm btn-primary" onclick="commitCsvImport(${JSON.stringify(colMap).replace(/"/g,'&quot;')}, ${JSON.stringify(lines).replace(/"/g,'&quot;')}, 'replace')">Replace collection</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function commitCsvImport(colMap, lines, mode) {
  document.getElementById('csv-preview-modal')?.remove();

  if (mode === 'replace') {
    await db.bottles.clear();
  }

  let imported = 0;
  const allRacks = await db.racks.toArray();
  const rackNameMap = {};
  allRacks.forEach(r => rackNameMap[r.name.toLowerCase()] = r.id);

  for (const line of lines) {
    const vals = parseCsvLine(line);
    const b = { addedAt: new Date().toISOString(), synced: false };
    colMap.forEach((key, i) => {
      if (!key || vals[i] === undefined || vals[i] === '') return;
      const v = vals[i].trim();
      // Type coerce numeric fields
      if (['vintage','quantity','score','row','col'].includes(key)) {
        const n = parseInt(v);
        if (!isNaN(n)) b[key] = n;
      } else if (['purchasePrice','marketValue'].includes(key)) {
        const n = parseFloat(v);
        if (!isNaN(n)) b[key] = n;
      } else if (key === 'rack') {
        // Try numeric ID first, then look up by name from 'Rack Name' column
        const n = parseInt(v);
        if (!isNaN(n)) b[key] = n;
      } else {
        b[key] = v;
      }
    });

    // Resolve rack name ‚Üí ID if we have it
    const rackNameIdx = colMap.indexOf(null); // 'Rack Name' won't map to a key
    // Find 'Rack Name' column from header
    if (!b.rack) {
      const rackNameColIdx = colMap.findIndex((k, i) => k === null && vals[i]);
      if (rackNameColIdx >= 0) {
        const rn = vals[rackNameColIdx]?.trim().toLowerCase();
        if (rn && rackNameMap[rn]) b.rack = rackNameMap[rn];
      }
    }

    if (b.name) {
      await db.bottles.add(b);
      imported++;
    }
  }

  await loadBottles();
  renderCollection();
  renderStats();
  githubPush({ silent: true });
  toast(`Imported ${imported} bottle${imported !== 1 ? 's' : ''} ‚úì`, 'success');
}

// ===========================
// SERVICE WORKER
// ===========================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' }).then(reg => {
    // Check for updates every time the page loads
    reg.update();

    // New SW is waiting (update downloaded) ‚Äî prompt user
    if (reg.waiting) {
      showUpdatePrompt(reg.waiting);
    }

    // Fires when a new SW finishes installing and is waiting to activate
    reg.addEventListener('updatefound', () => {
      const newSW = reg.installing;
      newSW.addEventListener('statechange', () => {
        if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
          showUpdatePrompt(newSW);
        }
      });
    });
  }).catch(() => {});

  // When the new SW takes control, reload the page to get fresh assets
  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (!refreshing) { refreshing = true; window.location.reload(); }
  });
}

function showUpdatePrompt(sw) {
  // Inject a banner at the top of the page
  const existing = document.getElementById('update-banner');
  if (existing) return;

  const banner = document.createElement('div');
  banner.id = 'update-banner';
  banner.style.cssText = `
    position: fixed; top: 56px; left: 0; right: 0; z-index: 999;
    background: #1f1109; border-bottom: 1px solid #c4952a;
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 20px; gap: 12px; font-family: 'Inconsolata', monospace;
    font-size: 11px; letter-spacing: 0.08em; color: #e8dcc8;
  `;
  banner.innerHTML = `
    <span>‚ü≥ &nbsp;A new version of Cave is available</span>
    <div style="display:flex;gap:8px">
      <button onclick="document.getElementById('update-banner').remove()" style="
        background:none;border:1px solid #4a3020;color:#8a7060;padding:4px 10px;
        font-family:inherit;font-size:10px;letter-spacing:0.1em;cursor:pointer;border-radius:2px;
      ">Later</button>
      <button onclick="applyUpdate()" id="update-apply-btn" style="
        background:none;border:1px solid #c4952a;color:#c4952a;padding:4px 10px;
        font-family:inherit;font-size:10px;letter-spacing:0.1em;cursor:pointer;border-radius:2px;
      ">Update Now</button>
    </div>
  `;
  document.body.appendChild(banner);

  // Store reference to the waiting SW so we can activate it on click
  window._pendingSW = sw;
}

function applyUpdate() {
  const btn = document.getElementById('update-apply-btn');
  if (btn) btn.textContent = 'Updating‚Ä¶';
  if (window._pendingSW) {
    window._pendingSW.postMessage({ type: 'SKIP_WAITING' });
  }
}

async function checkForAppUpdate(btn) {
  const statusEl = document.getElementById('update-check-status');
  const originalText = btn.textContent;
  btn.textContent = 'Checking‚Ä¶';
  btn.disabled = true;
  if (statusEl) { statusEl.style.display = 'none'; statusEl.textContent = ''; }

  // If there's already a pending SW waiting, just show the banner
  if (window._pendingSW) {
    btn.textContent = originalText;
    btn.disabled = false;
    showUpdatePrompt(window._pendingSW);
    closeModal('github-modal');
    return;
  }

  try {
    const reg = await navigator.serviceWorker.getRegistration('./');
    if (!reg) {
      btn.textContent = originalText;
      btn.disabled = false;
      if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Service worker not registered.'; }
      return;
    }

    // Force a network check for a new SW
    await reg.update();

    // Give it a moment to detect and install
    await new Promise(resolve => setTimeout(resolve, 2000));

    btn.textContent = originalText;
    btn.disabled = false;

    if (reg.waiting) {
      // New SW already waiting ‚Äî show update prompt
      showUpdatePrompt(reg.waiting);
      closeModal('github-modal');
    } else if (reg.installing) {
      // Still downloading ‚Äî wait for it
      if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Downloading update‚Ä¶'; }
      reg.installing.addEventListener('statechange', function() {
        if (this.state === 'installed' && navigator.serviceWorker.controller) {
          showUpdatePrompt(this);
          closeModal('github-modal');
        }
      });
    } else {
      // Already on latest
      if (statusEl) {
        statusEl.style.display = 'block';
        statusEl.textContent = `‚úì You're on the latest version (v${APP_VERSION})`;
        statusEl.style.color = 'var(--green)';
      }
    }
  } catch(e) {
    btn.textContent = originalText;
    btn.disabled = false;
    if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Update check failed ‚Äî check your connection.'; }
  }
}

// ===========================
// START
// ===========================
init();
</script>
</body>
</html>
